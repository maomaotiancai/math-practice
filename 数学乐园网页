<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁñØÁãÇÂä®Áâ©ÂüéÊï∞Â≠¶‰πêÂõ≠</title>
    <style>
        :root {
            --primary-color: var(--primary-color);
            --secondary-color: #ffd93d;
            --accent-color: #ff6b9d;
            --success-color: #00b894;
            --warning-color: #fdcb6e;
            --danger-color: var(--danger-color);
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --bg-warm: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            --bg-cool: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
            --bg-purple: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --shadow-sm: 0 2px 5px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 15px 50px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', 'ÂæÆËΩØÈõÖÈªë', cursive, sans-serif;
            background: linear-gradient(135deg, #ff9a56 0%, #ffcd67 50%, #ff9a56 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* ÊµÆÂä®ÁöÑÂä®Áâ©ËÉåÊôØË£ÖÈ•∞ */
        .floating-animals {
            position: fixed;
            font-size: 3em;
            opacity: 0.12;
            pointer-events: none;
            z-index: 0;
        }

        .animal1 { top: 10%; left: 5%; animation: float 8s ease-in-out infinite; }
        .animal2 { top: 20%; right: 10%; animation: float 10s ease-in-out infinite 1s; }
        .animal3 { bottom: 30%; left: 8%; animation: float 9s ease-in-out infinite 2s; }
        .animal4 { bottom: 15%; right: 5%; animation: float 11s ease-in-out infinite 0.5s; }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(3deg); }
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            position: relative;
            z-index: 1;
            border: 5px solid #ff6b6b;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            font-size: 2.8em;
            margin-bottom: 15px;
            text-shadow: 3px 3px 0px #ffd93d, 5px 5px 10px rgba(0,0,0,0.2);
            animation: titleBounce 2s ease-in-out infinite;
        }

        @keyframes titleBounce {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-8px) scale(1.02);
            }
        }

        /* ÂæΩÁ´†Â±ïÁ§∫Â¢ô */
        .badge-wall {
            background: var(--bg-warm);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-md);
        }

        .badge-wall h3 {
            text-align: center;
            color: var(--danger-color);
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .badge-collection {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .badge-group {
            text-align: center;
            background: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .badge-group:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .badge-group::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .badge-group:hover::before {
            opacity: 1;
        }

        .badge-icon {
            font-size: 3em;
            margin-bottom: 8px;
            display: inline-block;
            animation: badgeWiggle 2s ease-in-out infinite;
        }

        @keyframes badgeWiggle {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .badge-count {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .badge-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* ÁßØÂàÜÊòæÁ§∫ */
        .points-display {
            background: var(--bg-purple);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .points-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .points-icon {
            font-size: 2.5em;
        }

        .points-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--danger-color);
        }

        .points-label {
            font-size: 1em;
            color: var(--text-secondary);
            font-weight: bold;
        }

        .level-display {
            background: var(--bg-cool);
            padding: 10px 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-sm);
        }

        .level-text {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .xp-bar-container {
            flex: 1;
            margin-left: 20px;
        }

        .xp-label {
            font-size: 0.9em;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-weight: bold;
        }

        .xp-bar {
            height: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b894 0%, #55efc4 100%);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 8px;
        }

        /* Á≠æÂà∞Á≥ªÁªü */
        .daily-signin {
            background: var(--bg-purple);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .signin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .signin-btn {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
            padding: 12px 25px;
            border-radius: 15px;
            border: none;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .signin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .signin-btn.signed {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
            cursor: default;
        }

        .signin-status {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--danger-color);
        }

        /* ÂÆùÁÆ±Á≥ªÁªü */
        .chest-reward {
            background: var(--bg-warm);
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow-md);
            text-align: center;
            animation: chestBounce 0.6s ease;
        }

        @keyframes chestBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .chest-title {
            font-size: 1.5em;
            color: var(--danger-color);
            font-weight: bold;
            margin-bottom: 15px;
        }

        .chest-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .chest {
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .chest:hover {
            transform: translateY(-10px);
        }

        .chest-icon {
            font-size: 5em;
            filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.2));
        }

        .chest.wood {
            animation: chestShake 0.5s ease;
        }

        @keyframes chestShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .chest.silver {
            filter: drop-shadow(0 0 15px rgba(192, 192, 192, 0.5));
        }

        .chest.gold {
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
        }

        .chest-label {
            font-size: 1em;
            font-weight: bold;
            color: var(--text-primary);
            margin-top: 8px;
        }

        /* ÂºÄÁÆ±Âä®ÁîªË¶ÜÁõñÂ±Ç */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .chest-open-animation {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            animation: scaleIn 0.5s ease;
            max-width: 500px;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .reward-reveal {
            font-size: 8em;
            animation: rewardPop 0.8s ease;
        }

        @keyframes rewardPop {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: scale(1) rotate(10deg); opacity: 1; }
        }

        .reward-name {
            font-size: 2em;
            font-weight: bold;
            color: var(--danger-color);
            margin: 20px 0;
        }

        .rarity-stars {
            font-size: 2em;
            margin: 10px 0;
        }

        .collect-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .collect-btn:hover {
            transform: scale(1.05);
        }

        /* Âç°ÁâáÊî∂ÈõÜÂ±ïÁ§∫ */
        .cards-collection {
            background: linear-gradient(135deg, #dfe6e8 0%, #b2bec3 100%);
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow-md);
        }

        .cards-collection h3 {
            text-align: center;
            color: var(--text-primary);
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        .collected-card {
            background: white;
            padding: 10px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            position: relative;
            transition: all 0.3s;
        }

        .collected-card:hover {
            transform: translateY(-5px) scale(1.05);
        }

        .collected-card.rarity-1 {
            border: 3px solid #95a5a6;
        }

        .collected-card.rarity-2 {
            border: 3px solid #74b9ff;
        }

        .collected-card.rarity-3 {
            border: 3px solid #a29bfe;
            background: linear-gradient(135deg, #fff 0%, #f0f0ff 100%);
        }

        .collected-card .card-icon {
            font-size: 3em;
            margin-bottom: 5px;
        }

        .collected-card .card-name {
            font-size: 0.9em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .collected-card .card-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #d63031;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }

        .empty-cards {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-size: 1.1em;
        }

        /* ÊØèÊó•‰ªªÂä°Á≥ªÁªü */
        .daily-tasks {
            background: var(--bg-purple);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-md);
        }

        .daily-tasks h3 {
            text-align: center;
            color: var(--danger-color);
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .tasks-list {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .task-item {
            background: white;
            padding: 15px 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-sm);
            text-align: center;
            min-width: 180px;
            position: relative;
        }

        .task-item.completed {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        }

        .task-item.completed .task-title {
            color: white;
        }

        .task-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .task-title {
            font-size: 1em;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .task-reward {
            font-size: 0.9em;
            color: #e91e63;
            font-weight: bold;
        }

        .task-status {
            margin-top: 8px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .task-item.completed .task-status {
            color: white;
        }

        .claim-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .claim-btn:hover {
            transform: scale(1.05);
        }

        .claim-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        /* ËøûËÉúÂ•ñÂä±ÊòæÁ§∫ */
        .winning-streak {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-md);
            text-align: center;
            display: none;
        }

        .winning-streak.active {
            display: block;
            animation: streakPulse 2s ease-in-out infinite;
        }

        @keyframes streakPulse {
            0%, 100% { box-shadow: var(--shadow-md); }
            50% { box-shadow: 0 5px 25px rgba(255, 107, 157, 0.4); }
        }

        .streak-title {
            font-size: 1.5em;
            color: white;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .streak-count {
            font-size: 3em;
            font-weight: bold;
            color: #ffd93d;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .streak-fire {
            font-size: 2.5em;
        }

        .streak-reward {
            font-size: 1.2em;
            color: white;
            margin-top: 10px;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: 'ü¶äüê∞ü¶äüê∞';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8em;
            opacity: 0.05;
            white-space: nowrap;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
            gap: 15px;
        }

        .settings-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .difficulty-selector, .type-selector, .sound-toggle {
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(255,255,255,0.9);
            padding: 8px 15px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .difficulty-selector label,
        .type-selector label,
        .sound-toggle label {
            font-weight: bold;
            color: #667eea;
            font-size: 0.95em;
        }

        .difficulty-selector select,
        .type-selector select {
            padding: 6px 12px;
            border-radius: 10px;
            border: 2px solid #667eea;
            font-size: 15px;
            cursor: pointer;
            font-family: inherit;
            background: white;
            font-weight: bold;
        }

        .sound-toggle input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .timer-display {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .timer {
            font-size: 1.3em;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            border: 3px solid rgba(255,255,255,0.4);
        }

        /* ËøõÂ∫¶Êù° */
        .progress-container {
            width: 100%;
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: white;
            font-weight: bold;
            font-size: 0.95em;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: rgba(255,255,255,0.3);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 3px solid rgba(255,255,255,0.5);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff9a56 0%, #ffcd67 100%);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
            border-radius: 12px;
        }

        .progress-fill::after {
            content: 'üéØ';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        /* ÊåëÊàòÊ®°Âºè */
        .challenge-mode {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            display: none;
            position: relative;
            overflow: hidden;
        }

        .challenge-mode.active {
            display: block;
            animation: slideInDown 0.5s ease;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .challenge-title {
            font-size: 1.6em;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .countdown {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffd93d;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .countdown.urgent {
            color: #ff4757;
            animation: urgentPulse 0.5s infinite;
        }

        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* È¢òÁõÆÁΩëÊ†º */
        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .question-card {
            background: var(--bg-warm);
            padding: 20px;
            border-radius: 20px;
            border: 4px solid #f39c12;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .question-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .question-card:hover::before {
            opacity: 1;
        }

        .question-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .question-card.correct {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
            border-color: #00b894;
            animation: correctBounce 0.6s ease;
        }

        .question-card.wrong {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            border-color: var(--danger-color);
            animation: wrongShake 0.6s ease;
        }

        @keyframes correctBounce {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05); }
            50% { transform: scale(0.95); }
            75% { transform: scale(1.02); }
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
        }

        .question-number {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5em;
            opacity: 0.3;
            font-weight: bold;
        }

        .question-text {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .question-text.mixed {
            color: #e84393;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            font-size: 1.4em;
            border: 3px solid #dfe6e9;
            border-radius: 15px;
            text-align: center;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.3s;
            background: white;
        }

        .answer-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.4);
            transform: scale(1.02);
        }

        .answer-input.disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        /* ÂÆûÊó∂ÂèçÈ¶àÊ†áËÆ∞ */
        .feedback-icon {
            position: absolute;
            top: 10px;
            left: 15px;
            font-size: 2em;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s;
        }

        .question-card.correct .feedback-icon {
            opacity: 1;
            transform: scale(1);
            content: '‚úÖ';
        }

        .question-card.wrong .feedback-icon {
            opacity: 1;
            transform: scale(1);
        }

        /* Âä®Áâ©ÈºìÂä±ËØ≠Âä®Áîª */
        .animal-cheer {
            position: absolute;
            font-size: 1.5em;
            bottom: 10px;
            right: 10px;
            opacity: 0;
            animation: cheerPop 0.8s ease forwards;
            pointer-events: none;
            z-index: 10;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }

        @keyframes cheerPop {
            0% { opacity: 0; transform: scale(0) translateY(0); }
            30% { opacity: 1; transform: scale(1.2) translateY(-5px); }
            100% { opacity: 0; transform: scale(1) translateY(-25px); }
        }

        /* ÊåâÈíÆÊ†∑Âºè */
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 35px;
            font-size: 1.2em;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #55efc4 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }

        .btn-challenge {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
        }

        /* ÁªìÊûúÂ±ïÁ§∫Âå∫ */
        .result-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: var(--bg-cool);
            border-radius: 25px;
            animation: resultSlideIn 0.6s ease;
            position: relative;
            overflow: hidden;
        }

        @keyframes resultSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
        }

        .score-display {
            font-size: 3.5em;
            font-weight: bold;
            color: var(--text-primary);
            text-shadow: 3px 3px 0px rgba(255,255,255,0.5);
            margin-bottom: 15px;
        }

        /* ÊÆµ‰ΩçÂæΩÁ´† */
        .rank-badge {
            display: inline-block;
            padding: 15px 30px;
            border-radius: 20px;
            font-size: 1.8em;
            font-weight: bold;
            margin: 15px 0;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        /* Â•ñÁâåÂá∫Áé∞Âä®Áîª */
        @keyframes badgePop {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(10deg);
                opacity: 1;
            }
            75% {
                transform: scale(0.95) rotate(-5deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* Èó™ÂÖâÊïàÊûú */
        @keyframes shine {
            0% {
                left: -100%;
            }
            100% {
                left: 200%;
            }
        }

        .rank-badge::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: shine 2s infinite;
        }

        .rank-bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%);
            color: white;
            border: 4px solid #8b4513;
            animation: badgePop 0.8s ease, bronzeGlow 3s ease-in-out infinite;
        }

        @keyframes bronzeGlow {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(205, 127, 50, 0.4);
            }
            50% {
                box-shadow: 0 6px 25px rgba(205, 127, 50, 0.7);
            }
        }

        .rank-silver {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
            color: white;
            border: 4px solid #7f8c8d;
            animation: badgePop 0.8s ease, silverGlow 3s ease-in-out infinite 0.5s;
        }

        @keyframes silverGlow {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(189, 195, 199, 0.4);
            }
            50% {
                box-shadow: 0 6px 25px rgba(189, 195, 199, 0.7);
            }
        }

        .rank-gold {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: white;
            border: 4px solid #d4ac0d;
            animation: badgePop 0.8s ease, goldGlow 2.5s ease-in-out infinite 1s;
        }

        @keyframes goldGlow {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(241, 196, 15, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 8px 30px rgba(241, 196, 15, 0.8);
                transform: scale(1.03);
            }
        }

        .rank-diamond {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 50%, #a29bfe 100%);
            color: white;
            border: 4px solid #0652DD;
            animation: badgePop 0.8s ease, diamondGlow 2s ease-in-out infinite 1.5s, diamondSparkle 1.5s linear infinite;
        }

        @keyframes diamondGlow {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(9, 132, 227, 0.5),
                            0 0 30px rgba(162, 155, 254, 0.3);
            }
            50% {
                box-shadow: 0 8px 35px rgba(9, 132, 227, 0.8),
                            0 0 50px rgba(162, 155, 254, 0.5);
            }
        }

        @keyframes diamondSparkle {
            0%, 100% {
                filter: brightness(1) saturate(1);
            }
            50% {
                filter: brightness(1.15) saturate(1.2);
            }
        }

        /* ÊàêÂ∞±Â±ïÁ§∫ */
        .achievement-showcase {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-md);
        }

        .achievement-showcase.has-achievement {
            display: block;
            animation: achievementSlide 0.6s ease;
        }

        @keyframes achievementSlide {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .achievement-title {
            text-align: center;
            font-size: 1.5em;
            color: #e91e63;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .achievement-list {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .achievement-badge {
            background: var(--bg-warm);
            padding: 12px 20px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: achievementPop 0.5s ease;
        }

        @keyframes achievementPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .stars {
            font-size: 2.5em;
            margin: 15px 0;
            opacity: 0;
            animation: fadeIn 0.8s ease 0.6s forwards;
        }

        .encouragement {
            font-size: 1.5em;
            color: var(--text-primary);
            margin-top: 15px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            opacity: 0;
            animation: fadeIn 0.8s ease 0.9s forwards;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            min-width: 130px;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s;
        }

        .stat-item:hover {
            transform: translateY(-5px);
        }

        /* ÊúÄ‰Ω≥ÊàêÁª©Â±ïÁ§∫ */
        .best-score-display {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            margin-top: 15px;
            box-shadow: var(--shadow-sm);
        }

        .best-score-label {
            font-size: 1.1em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .best-score-number {
            font-size: 2em;
            font-weight: bold;
            color: #f39c12;
        }

        /* ËøûÁª≠ÁªÉ‰π†Â§©Êï∞ */
        .streak-display {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            margin-top: 10px;
            box-shadow: var(--shadow-sm);
        }

        .streak-label {
            font-size: 1.1em;
            color: #e91e63;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .streak-number {
            font-size: 2em;
            font-weight: bold;
            color: #e91e63;
        }

        .streak-fire {
            font-size: 1.5em;
            margin-left: 5px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 1em;
            color: var(--text-secondary);
            margin-top: 8px;
            font-weight: bold;
        }

        /* ÁÉüËä±ÁîªÂ∏É */
        #fireworksCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* ÈîôÈ¢òÈõÜ - Áøª‰π¶Âä®Áîª */
        .wrong-questions {
            margin-top: 25px;
            animation: bookOpen 0.8s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        @keyframes bookOpen {
            from {
                opacity: 0;
                transform: perspective(1000px) rotateY(-90deg);
            }
            to {
                opacity: 1;
                transform: perspective(1000px) rotateY(0deg);
            }
        }

        .wrong-questions h3 {
            color: var(--danger-color);
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
        }

        .wrong-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 18px;
            margin-bottom: 12px;
            border-radius: 15px;
            border-left: 6px solid #d63031;
            box-shadow: var(--shadow-sm);
        }

        .wrong-question {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .wrong-question.mixed {
            color: #e84393;
        }

        .wrong-answer {
            color: var(--danger-color);
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .correct-answer {
            color: #00b894;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .explanation {
            color: var(--text-secondary);
            background: #f5f5f5;
            padding: 12px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 1em;
        }

        /* ÂéÜÂè≤ËÆ∞ÂΩï */
        .history-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
        }

        .history-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.6em;
        }

        .history-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }

        .history-item:hover {
            transform: translateX(5px);
        }

        .history-date {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .history-score {
            font-weight: bold;
            font-size: 1.3em;
            color: #667eea;
        }

        .history-badges {
            font-size: 0.85em;
            margin-top: 5px;
        }

        .history-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            margin-right: 5px;
            font-weight: bold;
        }

        .history-badge.challenge {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
        }

        .history-badge.silver {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
            color: white;
        }

        .history-badge.gold {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
            color: white;
        }

        .history-badge.diamond {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }

        /* ÈöæÂ∫¶ÂõæÊ†á */
        .difficulty-icon {
            font-size: 1.2em;
            margin-right: 5px;
        }

        /* Áî®Êà∑ÁÆ°ÁêÜÁ≥ªÁªü */
        .user-manager {
            background: var(--bg-warm);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
        }

        .current-user {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .user-avatar {
            font-size: 2.5em;
            background: white;
            padding: 10px;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
            animation: avatarPulse 2s ease-in-out infinite;
        }

        @keyframes avatarPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: var(--shadow-sm);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
        }

        .user-name {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--danger-color);
            flex: 1;
            text-align: center;
        }

        .btn-switch-user {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
        }

        .btn-switch-user:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Áä∂ÊÄÅÈù¢Êùø */
        .status-panel {
            background: var(--bg-warm);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s;
        }

        .status-header:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--danger-color);
        }

        .status-toggle {
            font-size: 1em;
            transition: transform 0.3s;
        }

        .status-toggle.open {
            transform: rotate(180deg);
        }

        .status-toggle {
            animation: toggleBounce 2s ease-in-out infinite;
        }

        @keyframes toggleBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .status-content {
            padding: 0 20px 20px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Áî®Êà∑ÁÆ°ÁêÜÂºπÁ™ó */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--warning-color);
            padding-bottom: 15px;
        }

        .modal-header h3 {
            color: var(--danger-color);
            font-size: 1.5em;
        }

        .close-btn {
            background: var(--text-secondary);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: var(--danger-color);
            transform: rotate(90deg);
        }

        .user-list {
            margin-bottom: 25px;
        }

        .user-card {
            background: var(--bg-warm);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
        }

        .user-card:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .user-card.active {
            border: 3px solid var(--primary-color);
            background: var(--bg-purple);
        }

        .user-card-avatar {
            font-size: 2em;
        }

        .user-card-info {
            flex: 1;
        }

        .user-card-name {
            font-weight: bold;
            font-size: 1.1em;
            color: var(--text-primary);
        }

        .user-card-stats {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .user-card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-user-action {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-switch {
            background: var(--success-color);
            color: white;
        }

        .btn-edit {
            background: var(--warning-color);
            color: var(--text-primary);
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
        }

        .add-user-section {
            border-top: 2px solid var(--warning-color);
            padding-top: 20px;
        }

        .add-user-section h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .add-user-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--text-secondary);
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 15px;
            font-family: inherit;
        }

        .add-user-section input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .avatar-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .avatar-option {
            font-size: 2em;
            padding: 8px;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        .avatar-option.selected {
            border-color: var(--primary-color);
            background: var(--bg-purple);
            transform: scale(1.15);
        }

        /* ÈÄöÁî®Èò¥ÂΩ±Á±ª */
        .shadow-sm {
            box-shadow: var(--shadow-sm);
        }

        .shadow-md {
            box-shadow: var(--shadow-md);
        }

        .shadow-lg {
            box-shadow: var(--shadow-lg);
        }

        /* ÈÄöÁî®Ê∏êÂèòÁ±ª */
        .bg-warm {
            background: var(--bg-warm);
        }

        .bg-cool {
            background: var(--bg-cool);
        }

        .bg-purple {
            background: var(--bg-purple);
        }

        /* ÊéíË°åÊ¶ú */
        .leaderboard-section {
            background: var(--bg-warm);
            border-radius: 20px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: var(--shadow-md);
        }

        .leaderboard-header {
            margin-bottom: 20px;
        }

        .leaderboard-header h3 {
            text-align: center;
            color: var(--danger-color);
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .leaderboard-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .tab-btn {
            background: white;
            border: 2px solid var(--warning-color);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .tab-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .leaderboard-content {
            min-height: 200px;
        }

        .record-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
        }

        .record-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .record-rank {
            font-size: 1.5em;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        .record-rank.rank-1 {
            color: #ffd700;
            animation: goldShine 2s ease-in-out infinite;
        }

        .record-rank.rank-2 {
            color: #c0c0c0;
            animation: silverShine 2.5s ease-in-out infinite 0.3s;
        }

        .record-rank.rank-3 {
            color: #cd7f32;
            animation: bronzeShine 3s ease-in-out infinite 0.6s;
        }

        @keyframes goldShine {
            0%, 100% {
                transform: scale(1);
                text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            }
            50% {
                transform: scale(1.1);
                text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
        }

        @keyframes silverShine {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.08);
            }
        }

        @keyframes bronzeShine {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.06);
            }
        }

        .record-info {
            flex: 1;
        }

        .record-date {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .record-stats {
            display: flex;
            gap: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }

        .record-score {
            color: var(--primary-color);
        }

        .record-correct {
            color: var(--success-color);
        }

        .record-time {
            color: var(--accent-color);
        }

        .record-rank-badge {
            font-size: 1.2em;
            display: inline-block;
            animation: badgeRotate 3s ease-in-out infinite;
        }

        @keyframes badgeRotate {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .no-records {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .no-records p {
            font-size: 1.1em;
        }

        /* ÂìçÂ∫îÂºè */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .buttons, .difficulty-selector, .history-section, .user-manager,
            .status-panel, .leaderboard-section, .floating-animals, .overlay {
                display: none !important;
            }

            .container {
                box-shadow: none;
                border: none;
                padding: 20px;
                max-width: 100%;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 20px;
            }

            .questions-grid {
                grid-template-columns: repeat(2, 1fr);
                page-break-inside: avoid;
            }

            .question-card {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ccc;
                margin-bottom: 10px;
            }

            .question-card input {
                border: 1px solid #999;
                height: 30px;
            }

            .feedback-icon, .result-section, .challenge-mode {
                display: none !important;
            }

            .print-header {
                display: block !important;
                page-break-after: always;
                border-bottom: 2px solid #000;
                padding-bottom: 20px;
                margin-bottom: 30px;
            }

            .print-header h2 {
                font-size: 1.8em;
                margin-bottom: 15px;
            }

            .print-header p {
                font-size: 1em;
                margin: 5px 0;
                line-height: 1.6;
            }

            @page {
                size: A4;
                margin: 2cm;
            }
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }
            .questions-grid {
                grid-template-columns: 1fr;
            }
            .header-info {
                flex-direction: column;
                align-items: stretch;
            }
            .settings-row {
                flex-direction: column;
                align-items: stretch;
            }
            .timer-display {
                justify-content: center;
            }
            .score-display {
                font-size: 2.5em;
            }
            .rank-badge {
                font-size: 1.4em;
                padding: 12px 20px;
            }

            /* ÁßªÂä®Á´ØÊåâÈíÆ‰ºòÂåñ */
            .btn {
                min-height: 48px;
                min-width: 48px;
                font-size: 1em;
                padding: 12px 20px;
            }

            .btn:active {
                transform: scale(0.95);
            }

            .btn-switch-user {
                min-height: 44px;
                padding: 12px 18px;
            }

            .btn-switch-user:active {
                transform: scale(0.95);
            }

            .user-card-actions .btn-user-action {
                min-height: 40px;
                padding: 10px 15px;
            }

            .status-header {
                padding: 18px 15px;
            }

            .current-user {
                flex-wrap: wrap;
            }

            .avatar-selector {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- ÁÉüËä±ÁîªÂ∏É -->
    <canvas id="fireworksCanvas"></canvas>

    <!-- ÊµÆÂä®Âä®Áâ©Ë£ÖÈ•∞ -->
    <div class="floating-animals animal1">ü¶ä</div>
    <div class="floating-animals animal2">üê∞</div>
    <div class="floating-animals animal3">ü¶Å</div>
    <div class="floating-animals animal4">üê®</div>

    <div class="container">
        <h1>üéâ ÁñØÁãÇÂä®Áâ©ÂüéÊï∞Â≠¶‰πêÂõ≠ üéâ</h1>

        <!-- ÊâìÂç∞È°µÁúâÔºà‰ªÖÂú®ÊâìÂç∞Êó∂ÊòæÁ§∫Ôºâ -->
        <div class="print-header" style="display: none;">
            <h2>ÁñØÁãÇÂä®Áâ©ÂüéÊï∞Â≠¶‰πêÂõ≠ - ÁªÉ‰π†Êä•Âëä</h2>
            <p><strong>Â≠¶ÁîüÂßìÂêçÔºö</strong><span id="printStudentName"></span></p>
            <p><strong>ÁªÉ‰π†Êó•ÊúüÔºö</strong><span id="printDate"></span></p>
            <p><strong>ÈöæÂ∫¶Á≠âÁ∫ßÔºö</strong><span id="printDifficulty"></span></p>
            <p><strong>È¢òÁõÆÁ±ªÂûãÔºö</strong><span id="printQuestionType"></span></p>
            <p><strong>ÂÆåÊàêÊó∂Èó¥Ôºö</strong><span id="printTime"></span></p>
            <p><strong>ÂæóÂàÜÔºö</strong><span id="printScore"></span></p>
            <p><strong>ÊÆµ‰ΩçÔºö</strong><span id="printRank"></span></p>
        </div>

        <!-- Áî®Êà∑ÁÆ°ÁêÜ -->
        <div class="user-manager">
            <div class="current-user">
                <span class="user-avatar" id="currentUserAvatar">üë§</span>
                <span class="user-name" id="currentUserName">ËØ∑ÈÄâÊã©Áî®Êà∑</span>
                <button class="btn-switch-user" onclick="showUserModal()">üîÑ ÂàáÊç¢</button>
            </div>
        </div>

        <!-- ÊàëÁöÑÁä∂ÊÄÅÈù¢ÊùøÔºàÂèØÊäòÂè†Ôºâ -->
        <div class="status-panel">
            <div class="status-header" onclick="toggleStatusPanel()">
                <span class="status-title">üìä ÊàëÁöÑÁä∂ÊÄÅ</span>
                <span class="status-toggle" id="statusToggle">‚ñº</span>
            </div>
            <div class="status-content" id="statusContent" style="display: none;">
                <!-- ÂæΩÁ´†Â±ïÁ§∫Â¢ô -->
                <div class="badge-wall">
                    <h3>üèÜ ‰ªäÊó•ÂæΩÁ´† üèÜ</h3>
                    <div class="badge-collection">
                        <div class="badge-group">
                            <div class="badge-icon">ü•â</div>
                            <div class="badge-count" id="bronzeCount">0</div>
                            <div class="badge-label">ÈìúÁâå</div>
                        </div>
                        <div class="badge-group">
                            <div class="badge-icon">ü•à</div>
                            <div class="badge-count" id="silverCount">0</div>
                            <div class="badge-label">Èì∂Áâå</div>
                        </div>
                        <div class="badge-group">
                            <div class="badge-icon">ü•á</div>
                            <div class="badge-count" id="goldCount">0</div>
                            <div class="badge-label">ÈáëÁâå</div>
                        </div>
                        <div class="badge-group">
                            <div class="badge-icon">üíé</div>
                            <div class="badge-count" id="diamondCount">0</div>
                            <div class="badge-label">ÈíªÁü≥</div>
                        </div>
                    </div>
                </div>

                <!-- ÁßØÂàÜÂíåÁ≠âÁ∫ßÊòæÁ§∫ -->
                <div class="points-display">
                    <div class="points-info">
                        <div class="points-icon">‚≠ê</div>
                        <div>
                            <div class="points-value" id="pointsValue">0</div>
                            <div class="points-label">ÊàëÁöÑÁßØÂàÜ</div>
                        </div>
                    </div>
                    <div class="level-display">
                        <div class="level-text">üéÆ Lv.<span id="levelValue">1</span></div>
                    </div>
                    <div class="xp-bar-container">
                        <div style="width: 100%;">
                            <div class="xp-label">ÁªèÈ™åÂÄºÔºö<span id="xpValue">0</span> / <span id="xpMax">100</span></div>
                            <div class="xp-bar">
                                <div class="xp-fill" id="xpFill"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÊØèÊó•Á≠æÂà∞ -->
                <div class="daily-signin">
                    <div class="signin-info">
                        <div style="font-size: 2em;">üìÖ</div>
                        <div>
                            <div class="signin-status" id="signinStatus">‰ªäÊó•Â∑≤Á≠æÂà∞</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">ËøûÁª≠Á≠æÂà∞Ôºö<span id="signinStreak">0</span> Â§©</div>
                        </div>
                    </div>
                    <button class="signin-btn" id="signinBtn" onclick="dailySignIn()">‚úÖ Á≠æÂà∞</button>
                </div>

                <!-- ÊØèÊó•‰ªªÂä° -->
                <div class="daily-tasks">
                    <h3>üéØ ÊØèÊó•‰ªªÂä°</h3>
                    <div class="tasks-list" id="tasksList"></div>
                </div>

                <!-- ËøûËÉúÂ•ñÂä± -->
                <div class="winning-streak" id="winningStreak">
                    <div class="streak-title">üî• ËøûËÉúÂ•ñÂä± üî•</div>
                    <div class="streak-count"><span class="streak-fire">üî•</span> <span id="winningStreakCount">0</span> <span class="streak-fire">üî•</span></div>
                    <div class="streak-reward" id="streakReward">ËøûÁª≠Ëé∑ÂæóÈíªÁü≥Ëß£ÈîÅÂ•ñÂä±ÔºÅ</div>
                </div>
            </div>
        </div>

        <!-- Áî®Êà∑ÁÆ°ÁêÜÂºπÁ™ó -->
        <div class="modal" id="userModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üë• Áî®Êà∑ÁÆ°ÁêÜ</h3>
                    <button class="close-btn" onclick="closeUserModal()">‚úï</button>
                </div>
                <div class="user-list" id="userList">
                    <!-- Âä®ÊÄÅÁîüÊàêÁî®Êà∑ÂàóË°® -->
                </div>
                <div class="add-user-section">
                    <h4>Ê∑ªÂä†Êñ∞Áî®Êà∑</h4>
                    <input type="text" id="newUserName" placeholder="ËæìÂÖ•ÊòµÁß∞">
                    <div class="avatar-selector">
                        <span class="avatar-option selected" data-avatar="üê±" onclick="selectAvatar(this)">üê±</span>
                        <span class="avatar-option" data-avatar="üê∂" onclick="selectAvatar(this)">üê∂</span>
                        <span class="avatar-option" data-avatar="üê∞" onclick="selectAvatar(this)">üê∞</span>
                        <span class="avatar-option" data-avatar="ü¶ä" onclick="selectAvatar(this)">ü¶ä</span>
                        <span class="avatar-option" data-avatar="üêº" onclick="selectAvatar(this)">üêº</span>
                        <span class="avatar-option" data-avatar="üê®" onclick="selectAvatar(this)">üê®</span>
                        <span class="avatar-option" data-avatar="üêØ" onclick="selectAvatar(this)">üêØ</span>
                        <span class="avatar-option" data-avatar="ü¶Å" onclick="selectAvatar(this)">ü¶Å</span>
                    </div>
                    <button class="btn btn-primary" onclick="addNewUser()">‚ûï Ê∑ªÂä†</button>
                </div>
            </div>
        </div>

        <div class="header-section">
            <div class="header-info">
                <div class="settings-row">
                    <div class="difficulty-selector">
                        <label for="difficulty">ÈöæÂ∫¶Ôºö</label>
                        <select id="difficulty">
                            <option value="easy">üå± ÁÆÄÂçïÔºà20‰ª•ÂÜÖÔºâ</option>
                            <option value="medium" selected>üåø ‰∏≠Á≠âÔºà50‰ª•ÂÜÖÔºâ</option>
                            <option value="hard">üå≥ Âõ∞ÈöæÔºà100‰ª•ÂÜÖÔºâ</option>
                        </select>
                    </div>

                    <div class="type-selector">
                        <label for="questionType">È¢òÂûãÔºö</label>
                        <select id="questionType">
                            <option value="simple" selected>‚ûï ÁÆÄÂçïËøêÁÆó</option>
                            <option value="mixed">üî¢ Ê∑∑ÂêàËøêÁÆó</option>
                        </select>
                    </div>

                    <div class="sound-toggle">
                        <label for="soundEnabled">üîä Èü≥ÊïàÔºö</label>
                        <input type="checkbox" id="soundEnabled" checked>
                    </div>
                </div>

                <div class="timer-display">
                    <div class="timer">
                        ‚è±Ô∏è <span id="timer">00:00</span>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-label">
                    <span>üéØ ÂÆåÊàêËøõÂ∫¶</span>
                    <span id="progressText">0/20 È¢ò</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <div class="challenge-mode" id="challengeMode">
            <div class="challenge-header">
                <div class="challenge-title">‚ö° ÊåëÊàòÊ®°Âºè - ÈôêÊó∂Á≠îÈ¢ò</div>
                <div class="countdown" id="countdown">05:00</div>
            </div>
            <div style="text-align: center; color: white; font-size: 1.1em;">
                Âú®ËßÑÂÆöÊó∂Èó¥ÂÜÖÂÆåÊàêÊâÄÊúâÈ¢òÁõÆÔºåÊó∂Èó¥Âà∞Ëá™Âä®Êèê‰∫§ÔºÅüí™
            </div>
        </div>

        <div class="questions-grid" id="questionsGrid"></div>

        <div class="buttons">
            <button class="btn btn-challenge" id="challengeBtn" onclick="startChallenge()">‚ö° ÊåëÊàòÊ®°Âºè</button>
            <button class="btn btn-primary" id="submitBtn" onclick="submitAnswers()">‚úÖ Êèê‰∫§Á≠îÊ°à</button>
            <button class="btn btn-secondary" onclick="newQuestions()">üîÑ Êñ∞È¢òÁõÆ</button>
            <button class="btn btn-info" id="retryWrongBtn" onclick="retryWrong()" style="display: none;">üìù ÈáçÁªÉÈîôÈ¢ò</button>
            <button class="btn btn-success" onclick="window.print()">üñ®Ô∏è ÊâìÂç∞</button>
        </div>

        <div class="result-section" id="resultSection">
            <div class="result-header">
                <div class="score-display">
                    ÂæóÂàÜÔºö<span id="score">0</span>/100
                </div>
                <div class="rank-badge" id="rankBadge" style="display: none;"></div>
                <div class="stars" id="stars"></div>
                <div class="encouragement" id="encouragement"></div>
            </div>

            <!-- ÊàêÂ∞±Â±ïÁ§∫ -->
            <div class="achievement-showcase" id="achievementShowcase">
                <div class="achievement-title">üéä Ëß£ÈîÅÊàêÂ∞± üéä</div>
                <div class="achievement-list" id="achievementList"></div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">‚úÖ Á≠îÂØπ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="wrongCount">0</div>
                    <div class="stat-label">‚ùå Á≠îÈîô</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="timeSpent">00:00</div>
                    <div class="stat-label">‚è±Ô∏è Áî®Êó∂</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgTime">0s</div>
                    <div class="stat-label">‚ö° Âπ≥ÂùáÁ≠îÈ¢òÊó∂Èó¥</div>
                </div>
            </div>

            <!-- ÊúÄ‰Ω≥ÊàêÁª© -->
            <div class="best-score-display">
                <div class="best-score-label">üèÖ ÂéÜÂè≤ÊúÄÈ´òÂàÜ</div>
                <div class="best-score-number" id="bestScore">0</div>
            </div>

            <!-- ËøûÁª≠ÁªÉ‰π†Â§©Êï∞ -->
            <div class="streak-display">
                <div class="streak-label">üî• ËøûÁª≠ÁªÉ‰π†<span class="streak-fire"></span></div>
                <div class="streak-number"><span id="streakDays">0</span> Â§©</div>
            </div>

            <!-- ÂÆùÁÆ±Â•ñÂä± -->
            <div class="chest-reward" id="chestReward" style="display: none;">
                <div class="chest-title">üéÅ ÊÅ≠ÂñúÔºÅ‰Ω†Ëé∑Âæó‰∫ÜÂÆùÁÆ±ÔºÅ</div>
                <div class="chest-container" id="chestContainer"></div>
            </div>

            <!-- Âç°ÁâáÊî∂ÈõÜÂ±ïÁ§∫ -->
            <div class="cards-collection" id="cardsCollection">
                <h3>üé¥ ÊàëÁöÑÂä®Áâ©Âç°Áâá</h3>
                <div class="cards-grid" id="cardsGrid"></div>
            </div>

            <div class="wrong-questions" id="wrongSection" style="display: none;">
                <h3>‚ùå ÈîôÈ¢òÈõÜ</h3>
                <div id="wrongList"></div>
            </div>
        </div>

        <!-- ‰∏™‰∫∫ÊéíË°åÊ¶ú -->
        <div class="leaderboard-section">
            <div class="leaderboard-header">
                <h3>üèÜ ÊàëÁöÑÊéíË°åÊ¶ú</h3>
                <div class="leaderboard-tabs">
                    <button class="tab-btn active" data-tab="today" onclick="switchLeaderboardTab('today')">‰ªäÊó•ÊúÄ‰Ω≥</button>
                    <button class="tab-btn" data-tab="week" onclick="switchLeaderboardTab('week')">Êú¨Âë®ÊúÄ‰Ω≥</button>
                    <button class="tab-btn" data-tab="all" onclick="switchLeaderboardTab('all')">ÂéÜÂè≤ÊúÄ‰Ω≥</button>
                </div>
            </div>
            <div class="leaderboard-content" id="leaderboardContent">
                <!-- ÊòæÁ§∫ÂΩìÂâçÁî®Êà∑ÁöÑ‰∏™‰∫∫ÊéíË°å -->
                <div class="no-records">
                    <p>ËøòÊ≤°ÊúâËÆ∞ÂΩïÂì¶ÔºåÂø´ÂéªÁªÉ‰π†ÂêßÔºÅüí™</p>
                </div>
            </div>
        </div>

        <div class="history-section" id="historySection" style="display: none;">
            <h3>üìä ÂéÜÂè≤ËÆ∞ÂΩï</h3>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>

    <script>
        let questions = [];
        let timerInterval;
        let countdownInterval;
        let seconds = 0;
        let countdownSeconds = 300;
        let wrongQuestions = [];
        let isSubmitted = false;
        let isChallengeMode = false;
        let audioContext = null;
        let answeredCount = 0;
        let correctCount = 0;
        let currentQuestionIndex = 0;
        let questionTimes = [];

        // Âä®Áâ©ÈºìÂä±ËØ≠
        const animalCheers = [
            { animal: 'ü¶ä', text: 'Â§™Ê£í‰∫ÜÔºÅ' },
            { animal: 'üê∞', text: 'Â•ΩÂéâÂÆ≥ÔºÅ' },
            { animal: 'ü¶Å', text: 'ÁúüËÅ™ÊòéÔºÅ' },
            { animal: 'üê®', text: 'ÁªßÁª≠Âä†Ê≤πÔºÅ' },
            { animal: 'üêó', text: '‰Ω†ÁúüË°åÔºÅ' },
            { animal: 'üêº', text: '‰ºòÁßÄÔºÅ' },
            { animal: 'ü¶ä', text: 'ÁâõÂïäÔºÅ' },
            { animal: 'üê∞', text: 'ÂÆåÁæéÔºÅ' }
        ];

        // Èü≥ÊïàÁ≥ªÁªü - ÂçáÁ∫ßÁâàÂç°ÈÄöÈü≥Êïà
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            const soundEnabled = document.getElementById('soundEnabled').checked;
            if (!soundEnabled) return;

            initAudio();

            switch(type) {
                case 'correct':
                    // Á≠îÂØπÔºöÊÑâÊÇ¶ÁöÑ‰∏äÂçáÈü≥ÊïàÔºàÂèÆÂíöÔºâ
                    playMelody([523.25, 659.25, 783.99], [0, 0.1, 0.2], 0.3);
                    break;

                case 'wrong':
                    // Á≠îÈîôÔºö‰ΩéÊ≤âÁöÑÈîôËØØÈü≥ÔºàÂó°Âó°Ôºâ
                    playMelody([200, 150, 100], [0, 0.1, 0.2], 0.3);
                    break;

                case 'complete':
                    // ÂÆåÊàêÔºöËÉúÂà©ÊóãÂæã
                    playMelody([523.25, 659.25, 783.99, 1046.50, 783.99, 659.25], [0, 0.12, 0.24, 0.36, 0.48, 0.6], 0.8);
                    break;

                case 'diamond':
                    // ÈíªÁü≥ÊÆµ‰ΩçÔºöË∂ÖÁ∫ßËÉúÂà©Èü≥Êïà
                    playMelody([523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98, 2093.00], [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6], 1.0);
                    break;

                case 'click':
                    // ÁÇπÂáªÈü≥
                    playTone(800, 0.05, 0.1);
                    break;

                case 'timeout':
                    // Êó∂Èó¥Âà∞ÔºöÁ¥ßÊÄ•Èü≥
                    playMelody([400, 300, 200, 150], [0, 0.15, 0.3, 0.45], 0.6);
                    break;

                case 'firework':
                    // ÁÉüËä±Èü≥Êïà
                    playTone(1500, 0.1, 0.3);
                    break;
            }
        }

        function playMelody(frequencies, delays, duration) {
            frequencies.forEach((freq, i) => {
                setTimeout(() => {
                    playTone(freq, 0.2, duration);
                }, delays[i] * 1000);
            });
        }

        function playTone(frequency, volume, duration) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // ÁÉüËä±ÊïàÊûúÁ≥ªÁªü
        const canvas = document.getElementById('fireworksCanvas');
        const ctx = canvas.getContext('2d');
        let fireworks = [];
        let particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function createFirework(x, y) {
            const firework = {
                x: x,
                y: canvas.height,
                targetY: y,
                speed: 8 + Math.random() * 4,
                color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                exploded: false
            };
            fireworks.push(firework);
        }

        function createParticles(x, y, color) {
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    color: color,
                    alpha: 1,
                    size: Math.random() * 3 + 1
                });
            }
        }

        function createFlower(x, y) {
            // ÂàõÂª∫È≤úËä±ÊïàÊûú
            const flowerColors = ['#ff6b9d', '#c44569', '#ffecd2', '#fcb69f', '#ff9a56'];
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    createFirework(x + Math.cos(i * Math.PI / 4) * 100, y - 100);
                }, i * 100);
            }
        }

        function animateFireworks() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Êõ¥Êñ∞ÁÉüËä±
            fireworks.forEach((firework, index) => {
                firework.y -= firework.speed;

                if (firework.y <= firework.targetY) {
                    createParticles(firework.x, firework.y, firework.color);
                    playSound('firework');
                    fireworks.splice(index, 1);
                }
            });

            // Êõ¥Êñ∞Á≤íÂ≠ê
            particles.forEach((particle, index) => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.vy += 0.1; // ÈáçÂäõ
                particle.alpha -= 0.02;

                if (particle.alpha <= 0) {
                    particles.splice(index, 1);
                } else {
                    ctx.globalAlpha = particle.alpha;
                    ctx.fillStyle = particle.color;
                    ctx.beginPath();
                    ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            ctx.globalAlpha = 1;

            if (fireworks.length > 0 || particles.length > 0) {
                requestAnimationFrame(animateFireworks);
            }
        }

        function startFireworks() {
            // ‰ªéÂ±èÂπïÂ∫ïÈÉ®ÂèëÂ∞ÑÂ§ö‰∏™ÁÉüËä±
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    createFirework(
                        canvas.width * (0.2 + Math.random() * 0.6),
                        canvas.height * (0.2 + Math.random() * 0.3)
                    );
                }, i * 300);
            }
            animateFireworks();

            // Ê∑ªÂä†È≤úËä±ÊïàÊûú
            setTimeout(() => {
                createFlower(canvas.width / 2, canvas.height * 0.3);
            }, 1500);
        }

        // ========== Áî®Êà∑ÁÆ°ÁêÜÁ≥ªÁªü ==========

        let currentUserData = null;
        let selectedAvatar = 'üê±';

        // Âä†ËΩΩÁî®Êà∑ÂàóË°®
        function loadUsers() {
            const data = localStorage.getItem('mathUsers');
            return data ? JSON.parse(data) : { currentUserId: null, users: [] };
        }

        // ‰øùÂ≠òÁî®Êà∑ÂàóË°®
        function saveUsers(users) {
            localStorage.setItem('mathUsers', JSON.stringify(users));
        }

        // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑
        function getCurrentUser() {
            const usersData = loadUsers();
            if (!usersData.currentUserId) return null;
            return usersData.users.find(u => u.id === usersData.currentUserId) || null;
        }

        // ÂàáÊç¢Áî®Êà∑
        function switchUser(userId) {
            const usersData = loadUsers();
            usersData.currentUserId = userId;
            saveUsers(usersData);

            // ÈáçÊñ∞Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆ
            currentUserData = getCurrentUser();
            updateCurrentUserDisplay();
            loadUserData();

            // ÂÖ≥Èó≠ÂºπÁ™ó
            closeUserModal();
        }

        // Ê∑ªÂä†Êñ∞Áî®Êà∑
        function addNewUser() {
            const nameInput = document.getElementById('newUserName');
            const name = nameInput.value.trim();

            if (!name) {
                alert('ËØ∑ËæìÂÖ•Áî®Êà∑ÊòµÁß∞ÔºÅ');
                return;
            }

            const usersData = loadUsers();
            const newUser = {
                id: 'user_' + Date.now(),
                name: name,
                avatar: selectedAvatar,
                createdAt: new Date().toISOString(),
                totalScore: 0,
                level: 1,
                practiceDays: 0,
                points: 0,
                xp: 0,
                streak: 0
            };

            usersData.users.push(newUser);
            usersData.currentUserId = newUser.id;
            saveUsers(usersData);

            // ÂàùÂßãÂåñËØ•Áî®Êà∑ÁöÑÊï∞ÊçÆ
            const initialData = {
                bronzeBadges: 0,
                silverBadges: 0,
                goldBadges: 0,
                diamondBadges: 0,
                points: 0,
                level: 1,
                xp: 0,
                streak: 0,
                bestScore: 0,
                history: [],
                badgeDate: new Date().toDateString(),
                signinDate: null,
                signinStreak: 0,
                winningStreak: 0,
                tasks: {},
                cards: [],
                records: {
                    today: [],
                    week: [],
                    all: []
                }
            };
            localStorage.setItem('mathUserData_' + newUser.id, JSON.stringify(initialData));

            currentUserData = newUser;
            updateCurrentUserDisplay();
            loadUserData();
            renderUserList();

            // Ê∏ÖÁ©∫ËæìÂÖ•
            nameInput.value = '';
            closeUserModal();
        }

        // Âà†Èô§Áî®Êà∑
        function deleteUser(userId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Áî®Êà∑ÂêóÔºüÊâÄÊúâÊï∞ÊçÆÂ∞ÜË¢´Ê∏ÖÈô§ÔºÅ')) return;

            const usersData = loadUsers();
            usersData.users = usersData.users.filter(u => u.id !== userId);

            // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÁî®Êà∑ÔºåÂàáÊç¢Âà∞Á¨¨‰∏Ä‰∏™Áî®Êà∑
            if (usersData.currentUserId === userId) {
                usersData.currentUserId = usersData.users.length > 0 ? usersData.users[0].id : null;
            }

            // Âà†Èô§Áî®Êà∑Êï∞ÊçÆ
            localStorage.removeItem('mathUserData_' + userId);

            saveUsers(usersData);
            currentUserData = getCurrentUser();
            updateCurrentUserDisplay();
            loadUserData();
            renderUserList();
        }

        // ÁºñËæëÁî®Êà∑
        function editUser(userId) {
            const usersData = loadUsers();
            const user = usersData.users.find(u => u.id === userId);
            if (!user) return;

            const newName = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊòµÁß∞Ôºö', user.name);
            if (newName && newName.trim()) {
                user.name = newName.trim();
                saveUsers(usersData);
                renderUserList();
                updateCurrentUserDisplay();
            }
        }

        // ÊòæÁ§∫Áî®Êà∑ÁÆ°ÁêÜÂºπÁ™ó
        function showUserModal() {
            document.getElementById('userModal').classList.add('active');
            renderUserList();
        }

        // ÂÖ≥Èó≠Áî®Êà∑ÁÆ°ÁêÜÂºπÁ™ó
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        // ÈÄâÊã©Â§¥ÂÉè
        function selectAvatar(element) {
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedAvatar = element.dataset.avatar;
        }

        // Ê∏≤ÊüìÁî®Êà∑ÂàóË°®
        function renderUserList() {
            const usersData = loadUsers();
            const userList = document.getElementById('userList');

            if (usersData.users.length === 0) {
                userList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">ËøòÊ≤°ÊúâÁî®Êà∑ÔºåËØ∑Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Áî®Êà∑ÂêßÔºÅ</p>';
                return;
            }

            userList.innerHTML = usersData.users.map(user => `
                <div class="user-card ${user.id === usersData.currentUserId ? 'active' : ''}">
                    <div class="user-card-avatar">${user.avatar}</div>
                    <div class="user-card-info">
                        <div class="user-card-name">${user.name}</div>
                        <div class="user-card-stats">
                            Á≠âÁ∫ß ${user.level} ¬∑ ÁßØÂàÜ ${user.points} ¬∑ ËøûÁª≠ÁªÉ‰π† ${user.practiceDays} Â§©
                        </div>
                    </div>
                    <div class="user-card-actions">
                        ${user.id !== usersData.currentUserId ?
                            `<button class="btn-user-action btn-switch" onclick="switchUser('${user.id}')">ÂàáÊç¢</button>` :
                            '<span style="color: var(--success-color); font-weight: bold;">ÂΩìÂâç</span>'
                        }
                        <button class="btn-user-action btn-edit" onclick="editUser('${user.id}')">ÁºñËæë</button>
                        <button class="btn-user-action btn-delete" onclick="deleteUser('${user.id}')">Âà†Èô§</button>
                    </div>
                </div>
            `).join('');
        }

        // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑ÊòæÁ§∫
        function updateCurrentUserDisplay() {
            const user = getCurrentUser();
            const avatarEl = document.getElementById('currentUserAvatar');
            const nameEl = document.getElementById('currentUserName');

            if (user) {
                avatarEl.textContent = user.avatar;
                nameEl.textContent = user.name;
            } else {
                avatarEl.textContent = 'üë§';
                nameEl.textContent = 'ËØ∑ÈÄâÊã©Áî®Êà∑';
            }
        }

        // ÂàáÊç¢Áä∂ÊÄÅÈù¢Êùø
        function toggleStatusPanel() {
            const content = document.getElementById('statusContent');
            const toggle = document.getElementById('statusToggle');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.classList.add('open');
            } else {
                content.style.display = 'none';
                toggle.classList.remove('open');
            }
        }

        // ‰øÆÊîπÊï∞ÊçÆÂä†ËΩΩÂáΩÊï∞‰ª•ÊîØÊåÅÂ§öÁî®Êà∑
        const originalLoadUserData = window.loadUserData;
        function loadUserData() {
            const user = getCurrentUser();
            if (!user) return {};

            const key = 'mathUserData_' + user.id;
            try {
                return JSON.parse(localStorage.getItem(key) || '{}');
            } catch (e) {
                return {};
            }
        }

        function saveUserData(data) {
            const user = getCurrentUser();
            if (!user) return;

            const key = 'mathUserData_' + user.id;
            localStorage.setItem(key, JSON.stringify(data));

            // Êõ¥Êñ∞Áî®Êà∑ÁªüËÆ°
            const usersData = loadUsers();
            const userData = usersData.users.find(u => u.id === user.id);
            if (userData) {
                userData.points = data.points || 0;
                userData.level = data.level || 1;
                userData.xp = data.xp || 0;
                userData.streak = data.streak || 0;
                userData.practiceDays = data.streak || 0;
                saveUsers(usersData);
            }
        }

        // ========== ÊéíË°åÊ¶úÁ≥ªÁªü ==========

        let currentLeaderboardTab = 'today';

        // ‰øùÂ≠ò‰∏™‰∫∫ÊàêÁª©
        function savePersonalRecord(score, correct, time) {
            const user = getCurrentUser();
            if (!user) return;

            const data = loadUserData();
            if (!data.records) {
                data.records = { today: [], week: [], all: [] };
            }

            const record = {
                date: new Date().toISOString(),
                score: score,
                correct: correct,
                time: time,
                rank: getRankBadge(score)
            };

            // Ê∑ªÂä†Âà∞‰ªäÊó•ËÆ∞ÂΩï
            const today = new Date().toDateString();
            data.records.today = data.records.today.filter(r =>
                new Date(r.date).toDateString() !== today
            );
            data.records.today.push(record);

            // Êõ¥Êñ∞Êú¨Âë®ËÆ∞ÂΩï(‰øùÁïôÊØèÂ§©ÁöÑÊúÄ‰Ω≥)
            updateWeekRecords(data.records);

            // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï(‰øùÁïôÂâç10)
            data.records.all.push(record);
            data.records.all.sort((a, b) => b.score - a.score);
            data.records.all = data.records.all.slice(0, 10);

            saveUserData(data);
            updateLeaderboardDisplay();
        }

        // Êõ¥Êñ∞Êú¨Âë®ËÆ∞ÂΩï
        function updateWeekRecords(records) {
            const weekData = {};
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            records.today.forEach(r => {
                const date = new Date(r.date).toDateString();
                if (!weekData[date] || r.score > weekData[date].score) {
                    weekData[date] = r;
                }
            });

            records.week = Object.values(weekData)
                .filter(r => new Date(r.date) >= weekAgo)
                .sort((a, b) => b.score - a.score)
                .slice(0, 7);
        }

        // ÂàáÊç¢ÊéíË°åÊ¶úÊ†áÁ≠æ
        function switchLeaderboardTab(tab) {
            currentLeaderboardTab = tab;

            // Êõ¥Êñ∞Ê†áÁ≠æÊ†∑Âºè
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                }
            });

            renderLeaderboard();
        }

        // Ê∏≤ÊüìÊéíË°åÊ¶ú
        function renderLeaderboard() {
            const data = loadUserData();
            const content = document.getElementById('leaderboardContent');

            if (!data.records || !data.records[currentLeaderboardTab] || data.records[currentLeaderboardTab].length === 0) {
                content.innerHTML = `
                    <div class="no-records">
                        <p>ËøòÊ≤°Êúâ${currentLeaderboardTab === 'today' ? '‰ªäÊó•' : currentLeaderboardTab === 'week' ? 'Êú¨Âë®' : 'ÂéÜÂè≤'}ËÆ∞ÂΩïÂì¶ÔºåÂø´ÂéªÁªÉ‰π†ÂêßÔºÅüí™</p>
                    </div>
                `;
                return;
            }

            const records = data.records[currentLeaderboardTab];
            content.innerHTML = records.map((record, index) => `
                <div class="record-item">
                    <div class="record-rank rank-${index + 1}">${index + 1}</div>
                    <div class="record-info">
                        <div class="record-date">${formatRecordDate(record.date)}</div>
                        <div class="record-stats">
                            <span class="record-score">${record.score}ÂàÜ</span>
                            <span class="record-correct">‚úì${record.correct}</span>
                            <span class="record-time">${record.time}</span>
                        </div>
                    </div>
                    <div class="record-rank-badge">${record.rank}</div>
                </div>
            `).join('');
        }

        // Ê†ºÂºèÂåñËÆ∞ÂΩïÊó•Êúü
        function formatRecordDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            if (date.toDateString() === today.toDateString()) {
                return '‰ªäÂ§© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Êò®Â§© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }) +
                       ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // Êõ¥Êñ∞ÊéíË°åÊ¶úÊòæÁ§∫
        function updateLeaderboardDisplay() {
            renderLeaderboard();
        }

        // ÂàùÂßãÂåñÊéíË°åÊ¶ú
        function initLeaderboard() {
            updateLeaderboardDisplay();
        }

        // ========== ÊâìÂç∞ÂäüËÉΩ‰ºòÂåñ ==========

        // ÊâìÂç∞ÂâçÂáÜÂ§á
        window.addEventListener('beforeprint', function() {
            const user = getCurrentUser();
            const data = loadUserData();

            // Â°´ÂÖÖÊâìÂç∞‰ø°ÊÅØ
            document.getElementById('printStudentName').textContent = user ? user.name : 'Êú™ËÆæÁΩÆ';
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('zh-CN');
            document.getElementById('printDifficulty').textContent =
                document.getElementById('difficulty').options[document.getElementById('difficulty').selectedIndex].text;
            document.getElementById('printQuestionType').textContent =
                document.getElementById('questionType').options[document.getElementById('questionType').selectedIndex].text;

            if (isSubmitted) {
                document.getElementById('printTime').textContent = formatTime(seconds);
                document.getElementById('printScore').textContent = document.getElementById('score').textContent;
                const rankBadge = document.getElementById('rankBadge');
                document.getElementById('printRank').textContent = rankBadge.style.display !== 'none' ? rankBadge.textContent : 'Êú™ËØÑÂÆö';
            } else {
                document.getElementById('printTime').textContent = 'Êú™ÂÆåÊàê';
                document.getElementById('printScore').textContent = '-';
                document.getElementById('printRank').textContent = 'Êú™ËØÑÂÆö';
            }
        });

        // ÊâìÂç∞ÂêéÊ∏ÖÁêÜ
        window.addEventListener('afterprint', function() {
            // Ê∏ÖÁêÜÂ∑•‰ΩúÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
        });

        // ‰ºòÂåñÊâìÂç∞ÊåâÈíÆ
        function printPage() {
            window.print();
        }

        // ÊõøÊç¢ÂéüÊúâÁöÑÊâìÂç∞ÊåâÈíÆ
        document.addEventListener('DOMContentLoaded', function() {
            const printBtn = document.querySelector('.btn-success');
            if (printBtn && printBtn.textContent.includes('ÊâìÂç∞')) {
                printBtn.setAttribute('onclick', 'printPage()');
            }
        });

        // ========== ÂàùÂßãÂåñ ==========
        window.onload = function() {
            // ÂàùÂßãÂåñÁî®Êà∑Á≥ªÁªü
            currentUserData = getCurrentUser();
            updateCurrentUserDisplay();

            // Â¶ÇÊûúÊ≤°ÊúâÁî®Êà∑ÔºåËá™Âä®ÊâìÂºÄÁî®Êà∑ÁÆ°ÁêÜÂºπÁ™ó
            if (!currentUserData) {
                showUserModal();
            } else {
                loadUserData();

                // Ê£ÄÊü•ÊòØÂê¶ÊòØÊñ∞ÁöÑ‰∏ÄÂ§©ÔºåÂ¶ÇÊûúÊòØÂàôÈáçÁΩÆ‰ªäÊó•ÂæΩÁ´†
                const data = loadUserData();
                const today = new Date().toDateString();
                if (data.badgeDate !== today) {
                    data.badgeDate = today;
                    data.bronzeBadges = 0;
                    data.silverBadges = 0;
                    data.goldBadges = 0;
                    data.diamondBadges = 0;
                    saveUserData(data);
                }
            }

            newQuestions();
            loadHistory();
            updateBadgeWall();
            updateStreak();
            updatePoints();
            updateLevel();
            checkDailySignIn();
            loadCardsCollection();
            initDailyTasks();
            initLeaderboard();
        };

        // Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆ
        function loadUserData() {
            try {
                const data = JSON.parse(localStorage.getItem('mathUserData') || '{}');
                return data;
            } catch (e) {
                console.warn('localStorage‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®');
                return window.mathUserDataMemory || {};
            }
        }

        // ‰øùÂ≠òÁî®Êà∑Êï∞ÊçÆ
        function saveUserData(data) {
            try {
                localStorage.setItem('mathUserData', JSON.stringify(data));
            } catch (e) {
                console.warn('localStorage‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®');
                window.mathUserDataMemory = data;
            }
        }

        // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆ
        function loadHistoryData() {
            try {
                return JSON.parse(localStorage.getItem('mathHistory') || '[]');
            } catch (e) {
                console.warn('localStorage‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®');
                return window.mathHistoryMemory || [];
            }
        }

        // ‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩïÊï∞ÊçÆ
        function saveHistoryData(history) {
            try {
                localStorage.setItem('mathHistory', JSON.stringify(history));
            } catch (e) {
                console.warn('localStorage‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ®');
                window.mathHistoryMemory = history;
            }
        }

        // Êõ¥Êñ∞ÂæΩÁ´†Â¢ô
        function updateBadgeWall() {
            const data = loadUserData();

            // Ë∞ÉËØï‰ø°ÊÅØ
            console.log('updateBadgeWall - bronze:', data.bronzeBadges, 'silver:', data.silverBadges, 'gold:', data.goldBadges, 'diamond:', data.diamondBadges);

            // Áõ¥Êé•ÊòæÁ§∫ÂæΩÁ´†Êï∞ÈáèÔºà‰∏çÁÆ°ÊòØÂê¶ÊòØÊñ∞ÁöÑ‰∏ÄÂ§©ÔºåÂõ†‰∏∫Êï∞ÊçÆÂ∑≤ÁªèÂú®ÂÖ∂‰ªñÂú∞ÊñπÂ§ÑÁêÜ‰∫ÜÔºâ
            document.getElementById('bronzeCount').textContent = data.bronzeBadges || 0;
            document.getElementById('silverCount').textContent = data.silverBadges || 0;
            document.getElementById('goldCount').textContent = data.goldBadges || 0;
            document.getElementById('diamondCount').textContent = data.diamondBadges || 0;
        }

        // Ê£ÄÊü•ÊàêÂ∞±
        function checkAchievements(score, rank) {
            const data = loadUserData();
            const achievements = [];
            const history = loadHistoryData();

            // È¶ñÊ¨°ÈíªÁü≥
            if (rank === 'diamond' && !data.firstDiamond) {
                achievements.push('üíé ÈíªÁü≥Âàù‰ΩìÈ™å');
                data.firstDiamond = true;
            }

            // ËøûÁª≠3Ê¨°ÈíªÁü≥
            const recentDiamonds = history.filter(h => h.rank === 'diamond').slice(0, 3);
            if (recentDiamonds.length === 3 && !data.threeDiamonds) {
                achievements.push('üî• ÈíªÁü≥Ëææ‰∫∫');
                data.threeDiamonds = true;
            }

            // Á¥ØËÆ°10Ê¨°Êª°ÂàÜ
            const diamondCount = history.filter(h => h.rank === 'diamond').length;
            if (diamondCount >= 10 && !data.tenDiamonds) {
                achievements.push('üèÜ Êï∞Â≠¶‰πãÁéã');
                data.tenDiamonds = true;
            }

            // È¶ñÊ¨°ÈªÑÈáë
            if (rank === 'gold' && !data.firstGold) {
                achievements.push('ü•á ÈªÑÈáëÊñ∞Êòü');
                data.firstGold = true;
            }

            // È¶ñÊ¨°ÁªÉ‰π†
            if (history.length === 1 && !data.firstPractice) {
                achievements.push('üéØ ÂºÄÂßã‰πãÊóÖ');
                data.firstPractice = true;
            }

            // 5Ê¨°ÁªÉ‰π†
            if (history.length >= 5 && !data.fivePractices) {
                achievements.push('üìö Âã§Â•ãÂ•ΩÂ≠¶');
                data.fivePractices = true;
            }

            // ËøûÁª≠7Â§©ÁªÉ‰π†
            if (data.streak >= 7 && !data.weekStreak) {
                achievements.push('üî• Âë®ÂÜ†ÂÜõ');
                data.weekStreak = true;
            }

            saveUserData(data);
            return achievements;
        }

        // Êõ¥Êñ∞ËøûÁª≠ÁªÉ‰π†Â§©Êï∞
        function updateStreak() {
            const data = loadUserData();
            const today = new Date().toDateString();
            let streak = data.streak || 0;
            let lastDate = data.lastDate || '';

            if (lastDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                if (lastDate === yesterday.toDateString()) {
                    streak++;
                } else if (lastDate !== today) {
                    streak = 1;
                }

                data.streak = streak;
                data.lastDate = today;
                saveUserData(data);
            }

            document.getElementById('streakDays').textContent = streak;
        }

        // ÁßØÂàÜÁ≥ªÁªü
        function updatePoints() {
            const data = loadUserData();
            document.getElementById('pointsValue').textContent = data.points || 0;
        }

        function addPoints(points) {
            const data = loadUserData();
            data.points = (data.points || 0) + points;
            saveUserData(data);
            updatePoints();
        }

        // Á≠âÁ∫ßÁ≥ªÁªü
        function updateLevel() {
            const data = loadUserData();
            const level = data.level || 1;
            const xp = data.xp || 0;
            const xpNeeded = level * 100;

            document.getElementById('levelValue').textContent = level;
            document.getElementById('xpValue').textContent = xp;
            document.getElementById('xpMax').textContent = xpNeeded;
            document.getElementById('xpFill').style.width = (xp / xpNeeded * 100) + '%';
        }

        function addXP(amount) {
            const data = loadUserData();
            let level = data.level || 1;
            let xp = (data.xp || 0) + amount;
            const xpNeeded = level * 100;

            while (xp >= xpNeeded) {
                xp -= xpNeeded;
                level++;
                playSound('diamond'); // ÂçáÁ∫ßÈü≥Êïà
            }

            data.level = level;
            data.xp = xp;
            saveUserData(data);
            updateLevel();

            if (level > (data.previousLevel || 0)) {
                showLevelUp(level);
                data.previousLevel = level;
                saveUserData(data);
            }
        }

        function showLevelUp(level) {
            alert(`üéâ ÊÅ≠ÂñúÂçáÁ∫ß‰∫ÜÔºÅÂΩìÂâçÁ≠âÁ∫ßÔºöLv.${level}`);
        }

        // ÊØèÊó•Á≠æÂà∞Á≥ªÁªü
        function checkDailySignIn() {
            const data = loadUserData();
            const today = new Date().toDateString();
            const signinBtn = document.getElementById('signinBtn');
            const signinStatus = document.getElementById('signinStatus');

            if (data.lastSignInDate === today) {
                signinBtn.textContent = '‚úÖ Â∑≤Á≠æÂà∞';
                signinBtn.classList.add('signed');
                signinBtn.disabled = true;
                signinStatus.textContent = '‰ªäÊó•Â∑≤Á≠æÂà∞';
            } else {
                signinBtn.textContent = '‚úÖ Á≠æÂà∞';
                signinBtn.classList.remove('signed');
                signinBtn.disabled = false;
                signinStatus.textContent = 'Êú™Á≠æÂà∞';
            }

            document.getElementById('signinStreak').textContent = data.signinStreak || 0;
        }

        function dailySignIn() {
            const data = loadUserData();
            const today = new Date().toDateString();

            if (data.lastSignInDate === today) return;

            // Ê£ÄÊü•ÊòØÂê¶ËøûÁª≠Á≠æÂà∞
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);

            if (data.lastSignInDate === yesterday.toDateString()) {
                data.signinStreak = (data.signinStreak || 0) + 1;
            } else {
                data.signinStreak = 1;
            }

            data.lastSignInDate = today;
            saveUserData(data);

            // Á≠æÂà∞Â•ñÂä±
            const streakBonus = (data.signinStreak - 1) * 20;
            const totalPoints = 30 + streakBonus;
            addPoints(totalPoints);

            alert(`üéâ Á≠æÂà∞ÊàêÂäüÔºÅËé∑Âæó ${totalPoints} ÁßØÂàÜ\nËøûÁª≠Á≠æÂà∞${data.signinStreak}Â§©ÔºåÈ¢ùÂ§ñÂ•ñÂä± ${streakBonus} ÁßØÂàÜ`);

            checkDailySignIn();
        }

        // ÂÆùÁÆ±Á≥ªÁªü
        function showChestReward(rank) {
            const chestContainer = document.getElementById('chestContainer');
            chestContainer.innerHTML = '';

            let chestType, chestIcon;
            switch(rank) {
                case 'silver':
                    chestType = 'wood';
                    chestIcon = 'üì¶';
                    break;
                case 'gold':
                    chestType = 'silver';
                    chestIcon = 'üíé';
                    break;
                case 'diamond':
                    chestType = 'gold';
                    chestIcon = 'üëë';
                    break;
            }

            const chest = document.createElement('div');
            chest.className = `chest ${chestType}`;
            chest.innerHTML = `
                <div class="chest-icon">${chestIcon}</div>
                <div class="chest-label">ÁÇπÂáªÂºÄÁÆ±</div>
            `;
            chest.onclick = () => openChest(rank);

            chestContainer.appendChild(chest);
            document.getElementById('chestReward').style.display = 'block';
        }

        function openChest(rank) {
            const overlay = document.getElementById('overlay');
            overlay.classList.add('active');

            // ÁîüÊàêÈöèÊú∫Â•ñÂä±
            const reward = generateReward(rank);
            displayReward(reward);
        }

        function generateReward(rank) {
            // Ê†πÊçÆÊÆµ‰ΩçÁîüÊàêÂ•ñÂä±
            const cardPool = [
                { icon: 'ü¶ä', name: 'Êú±Ëø™', rarity: 1 },
                { icon: 'üê∞', name: 'Êú±Ëø™', rarity: 1 },
                { icon: 'ü¶Å', name: 'ÁãÆÂ≠êÂ∏ÇÈïø', rarity: 2 },
                { icon: 'üê®', name: 'Ê†ëÊáíÈó™Áîµ', rarity: 1 },
                { icon: 'üêó', name: ' Manchas', rarity: 2 },
                { icon: 'üêº', name: 'Ë≠¶ÂÆòÁÜäÁå´', rarity: 3 },
                { icon: 'ü¶ä', name: 'Â∞ºÂÖã', rarity: 2 },
                { icon: 'üê∞', name: 'Ë≠¶ÂÆòÊú±Ëø™', rarity: 3 },
                { icon: '‚≠ê', name: 'ÊòüÊòüË¥¥Á∫∏', rarity: 1 },
                { icon: 'üåü', name: 'Èó™‰∫ÆË¥¥Á∫∏', rarity: 1 },
                { icon: '‚ú®', name: 'È≠îÊ≥ïË¥¥Á∫∏', rarity: 2 },
                { icon: 'üéÄ', name: 'Ëä±ÊúµË¥¥Á∫∏', rarity: 2 },
                { icon: 'üèÜ', name: 'Â•ñÊùØ', rarity: 3 }
            ];

            // Ê†πÊçÆÊÆµ‰ΩçÊèêÈ´òÁ®ÄÊúâÂ∫¶Ê¶ÇÁéá
            let rarityWeights;
            switch(rank) {
                case 'silver':
                    rarityWeights = [0.6, 0.3, 0.1]; // 60%ÊôÆÈÄöÔºå30%Á®ÄÊúâÔºå10%Âè≤ËØó
                    break;
                case 'gold':
                    rarityWeights = [0.4, 0.4, 0.2];
                    break;
                case 'diamond':
                    rarityWeights = [0.2, 0.5, 0.3]; // ÈíªÁü≥Êõ¥ÂÆπÊòìÂæóÁ®ÄÊúâÂíåÂè≤ËØó
                    break;
            }

            const rarity = Math.random();
            let selectedRarity;
            if (rarity < rarityWeights[0]) {
                selectedRarity = 1;
            } else if (rarity < rarityWeights[0] + rarityWeights[1]) {
                selectedRarity = 2;
            } else {
                selectedRarity = 3;
            }

            // ‰ªéÂØπÂ∫îÁ®ÄÊúâÂ∫¶‰∏≠ÈöèÊú∫ÈÄâÊã©
            const availableCards = cardPool.filter(c => c.rarity === selectedRarity);
            return availableCards[Math.floor(Math.random() * availableCards.length)];
        }

        function displayReward(reward) {
            const rewardReveal = document.getElementById('rewardReveal');
            const rewardName = document.getElementById('rewardName');
            const rarityStars = document.getElementById('rarityStars');

            rewardReveal.textContent = reward.icon;
            rewardName.textContent = reward.name;

            const stars = '‚≠ê'.repeat(reward.rarity);
            rarityStars.textContent = stars;

            // ‰øùÂ≠òÂà∞Êî∂Ëóè
            saveCard(reward);
        }

        function collectReward() {
            document.getElementById('overlay').classList.remove('active');
            loadCardsCollection();
        }

        // Âç°ÁâáÊî∂ÈõÜÁ≥ªÁªü
        function saveCard(card) {
            const data = loadUserData();
            if (!data.cards) data.cards = {};

            if (!data.cards[card.icon]) {
                data.cards[card.icon] = {
                    name: card.name,
                    rarity: card.rarity,
                    count: 0
                };
            }

            data.cards[card.icon].count++;
            saveUserData(data);
        }

        function loadCardsCollection() {
            const data = loadUserData();
            const cardsGrid = document.getElementById('cardsGrid');
            cardsGrid.innerHTML = '';

            const cards = data.cards || {};
            const cardList = Object.entries(cards);

            if (cardList.length === 0) {
                cardsGrid.innerHTML = '<div class="empty-cards">ËøòÊ≤°ÊúâÂç°ÁâáÂì¶ÔºåÂø´ÂéªÂºÄÂÆùÁÆ±Êî∂ÈõÜÂêßÔºÅüéÅ</div>';
                return;
            }

            cardList.forEach(([icon, cardData]) => {
                const cardEl = document.createElement('div');
                cardEl.className = `collected-card rarity-${cardData.rarity}`;
                cardEl.innerHTML = `
                    <div class="card-count">${cardData.count}</div>
                    <div class="card-icon">${icon}</div>
                    <div class="card-name">${cardData.name}</div>
                `;
                cardsGrid.appendChild(cardEl);
            });
        }

        // ÊØèÊó•‰ªªÂä°Á≥ªÁªü
        function initDailyTasks() {
            const data = loadUserData();
            const today = new Date().toDateString();

            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÁîüÊàêÊñ∞‰ªªÂä°ÔºàÊØèÂ§©Á¨¨‰∏ÄÊ¨°Ôºâ
            if (data.dailyTasksDate !== today) {
                data.dailyTasksDate = today;
                data.dailyTasks = {
                    task1: { completed: false, claimed: false },
                    task2: { completed: false, claimed: false },
                    task3: { completed: false, claimed: false }
                };
                saveUserData(data);
            }

            renderDailyTasks();
        }

        function renderDailyTasks() {
            const data = loadUserData();
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '';

            const tasks = [
                {
                    id: 'task1',
                    icon: '‚úèÔ∏è',
                    title: 'ÂÆåÊàê‰∏ÄÊ¨°ÁªÉ‰π†',
                    reward: '50ÁßØÂàÜ',
                    condition: (data) => true // ÊÄªÊòØÂèØÂÆåÊàê
                },
                {
                    id: 'task2',
                    icon: 'üéØ',
                    title: 'Ëé∑ÂæóÈªÑÈáëÊàñ‰ª•‰∏ä',
                    reward: '100ÁßØÂàÜ',
                    condition: (data) => data.lastRank === 'gold' || data.lastRank === 'diamond'
                },
                {
                    id: 'task3',
                    icon: '‚≠ê',
                    title: 'Á≠îÂØπ18È¢ò‰ª•‰∏ä',
                    reward: '150ÁßØÂàÜ',
                    condition: (data) => data.lastCorrect >= 18
                }
            ];

            tasks.forEach(task => {
                const taskData = data.dailyTasks[task.id];
                const isCompleted = taskData.completed;
                const canClaim = isCompleted && !taskData.claimed;

                const taskEl = document.createElement('div');
                taskEl.className = `task-item ${isCompleted ? 'completed' : ''}`;

                let buttonHTML = '';
                if (isCompleted && !taskData.claimed) {
                    buttonHTML = `<button class="claim-btn" onclick="claimTask('${task.id}')">È¢ÜÂèñÂ•ñÂä±</button>`;
                } else if (taskData.claimed) {
                    buttonHTML = `<button class="claim-btn disabled" disabled>Â∑≤È¢ÜÂèñ</button>`;
                }

                taskEl.innerHTML = `
                    <div class="task-icon">${task.icon}</div>
                    <div class="task-title">${task.title}</div>
                    <div class="task-reward">${task.reward}</div>
                    <div class="task-status">${isCompleted ? '‚úÖ Â∑≤ÂÆåÊàê' : 'ËøõË°å‰∏≠...'}</div>
                    ${buttonHTML}
                `;

                tasksList.appendChild(taskEl);
            });
        }

        function claimTask(taskId) {
            const data = loadUserData();
            const task = data.dailyTasks[taskId];

            if (!task.completed || task.claimed) return;

            task.claimed = true;

            // Áªô‰∫àÂ•ñÂä±
            let reward = 0;
            switch(taskId) {
                case 'task1': reward = 50; break;
                case 'task2': reward = 100; break;
                case 'task3': reward = 150; break;
            }

            addPoints(reward);
            saveUserData(data);
            renderDailyTasks();

            alert(`üéâ È¢ÜÂèñÊàêÂäüÔºÅËé∑Âæó ${reward} ÁßØÂàÜ`);
        }

        function checkDailyTasks() {
            const data = loadUserData();
            const tasks = data.dailyTasks || {};

            // ‰ªªÂä°1ÔºöÂÆåÊàê‰∏ÄÊ¨°ÁªÉ‰π†
            tasks.task1.completed = true;

            // ‰ªªÂä°2ÔºöÊ£ÄÊü•‰∏äÊ¨°ÊÆµ‰Ωç
            tasks.task2.completed = data.lastRank === 'gold' || data.lastRank === 'diamond';

            // ‰ªªÂä°3ÔºöÊ£ÄÊü•Á≠îÂØπÈ¢òÊï∞
            tasks.task3.completed = data.lastCorrect >= 18;

            data.dailyTasks = tasks;
            saveUserData(data);
            renderDailyTasks();
        }

        // ËøûËÉúÂ•ñÂä±Á≥ªÁªü
        function checkWinningStreak() {
            const data = loadUserData();
            const history = loadHistoryData();

            // ËÆ°ÁÆóËøûÁª≠ÈíªÁü≥Ê¨°Êï∞
            let streak = 0;
            for (let i = 0; i < history.length; i++) {
                if (history[i].rank === 'diamond') {
                    streak++;
                } else {
                    break;
                }
            }

            if (streak >= 2) {
                const streakDiv = document.getElementById('winningStreak');
                const streakCount = document.getElementById('winningStreakCount');
                const streakReward = document.getElementById('streakReward');

                document.getElementById('winningStreakCount').textContent = streak;
                streakDiv.classList.add('active');

                // ËøûËÉúÂ•ñÂä±
                if (streak >= 2 && !data.claimedStreak) {
                    const bonusPoints = streak * 100;
                    addPoints(bonusPoints);
                    streakReward.textContent = `ËøûÁª≠${streak}Ê¨°ÈíªÁü≥ÔºÅËé∑Âæó ${bonusPoints} ÁßØÂàÜÂ•ñÂä±ÔºÅ`;
                    data.claimedStreak = streak;
                    saveUserData(data);
                } else if (data.claimedStreak) {
                    streakReward.textContent = `Â∑≤È¢ÜÂèñËøûÁª≠${data.claimedStreak}Ê¨°Â•ñÂä±`;
                }
            } else {
                document.getElementById('winningStreak').classList.remove('active');
            }
        }

        // ÂêØÂä®ÊåëÊàòÊ®°Âºè
        function startChallenge() {
            if (isChallengeMode) return;

            isChallengeMode = true;
            countdownSeconds = 300;
            document.getElementById('challengeMode').classList.add('active');
            document.getElementById('challengeBtn').style.display = 'none';

            playSound('click');

            newQuestions();
            startCountdown();
        }

        // ÂºÄÂßãÂÄíËÆ°Êó∂
        function startCountdown() {
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                updateCountdownDisplay();

                if (countdownSeconds <= 0) {
                    stopCountdown();
                    playSound('timeout');
                    alert('‚è∞ Êó∂Èó¥Âà∞ÔºÅËá™Âä®Êèê‰∫§Á≠îÊ°àÔºÅ');
                    submitAnswers();
                }
            }, 1000);
        }

        // ÂÅúÊ≠¢ÂÄíËÆ°Êó∂
        function stopCountdown() {
            clearInterval(countdownInterval);
        }

        // Êõ¥Êñ∞ÂÄíËÆ°Êó∂ÊòæÁ§∫
        function updateCountdownDisplay() {
            const countdownEl = document.getElementById('countdown');
            const mins = Math.floor(countdownSeconds / 60);
            const secs = countdownSeconds % 60;
            countdownEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            if (countdownSeconds <= 30) {
                countdownEl.classList.add('urgent');
            } else {
                countdownEl.classList.remove('urgent');
            }
        }

        // ÁîüÊàêÊñ∞È¢òÁõÆ
        function newQuestions() {
            const difficulty = document.getElementById('difficulty').value;
            const questionType = document.getElementById('questionType').value;
            questions = [];
            let maxNum;

            switch(difficulty) {
                case 'easy': maxNum = 20; break;
                case 'medium': maxNum = 50; break;
                case 'hard': maxNum = 100; break;
            }

            for (let i = 0; i < 20; i++) {
                let question = questionType === 'mixed' ? generateMixedQuestion(maxNum) : generateQuestion(maxNum);
                questions.push(question);
            }

            renderQuestions();
            resetTimer();
            startTimer();
            isSubmitted = false;
            answeredCount = 0;
            correctCount = 0;
            wrongQuestions = [];
            questionTimes = [];
            currentQuestionIndex = 0;
            updateProgress();
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('retryWrongBtn').style.display = 'none';

            playSound('click');
        }

        // ÁîüÊàêÂçï‰∏™È¢òÁõÆ
        function generateQuestion(maxNum) {
            const isAddition = Math.random() > 0.5;
            let num1, num2, answer, operator;

            if (isAddition) {
                num1 = Math.floor(Math.random() * (maxNum - 1)) + 1;
                num2 = Math.floor(Math.random() * (maxNum - num1)) + 1;
                answer = num1 + num2;
                operator = '+';
            } else {
                num1 = Math.floor(Math.random() * maxNum) + 1;
                num2 = Math.floor(Math.random() * num1);
                answer = num1 - num2;
                operator = '-';
            }

            return {
                num1, num2, operator, answer,
                isMixed: false,
                userAnswer: '',
                isAnswered: false,
                isCorrect: false
            };
        }

        // ÁîüÊàêÊ∑∑ÂêàËøêÁÆóÈ¢òÁõÆ
        function generateMixedQuestion(maxNum) {
            const num1 = Math.floor(Math.random() * maxNum) + 1;
            const num2 = Math.floor(Math.random() * maxNum) + 1;
            const num3 = Math.floor(Math.random() * maxNum) + 1;
            const op1 = Math.random() > 0.5 ? '+' : '-';
            const op2 = Math.random() > 0.5 ? '+' : '-';

            let tempResult = op1 === '+' ? num1 + num2 : num1 - num2;
            if (tempResult < 0) return generateMixedQuestion(maxNum);

            let finalAnswer;
            if (op2 === '+') {
                finalAnswer = tempResult + num3;
            } else {
                if (tempResult < num3) return generateMixedQuestion(maxNum);
                finalAnswer = tempResult - num3;
            }

            return {
                num1, num2, num3, op1, op2,
                answer: finalAnswer,
                isMixed: true,
                userAnswer: '',
                isAnswered: false,
                isCorrect: false
            };
        }

        // Ê∏≤ÊüìÈ¢òÁõÆ
        function renderQuestions() {
            const grid = document.getElementById('questionsGrid');
            grid.innerHTML = '';

            questions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.id = `question-${index}`;

                let questionText = q.isMixed ?
                    `${index + 1}. ${q.num1} ${q.op1} ${q.num2} ${q.op2} ${q.num3} =` :
                    `${index + 1}. ${q.num1} ${q.operator} ${q.num2} =`;

                card.innerHTML = `
                    <div class="question-number">${index + 1}</div>
                    <div class="feedback-icon" id="feedback-${index}"></div>
                    <div class="question-text ${q.isMixed ? 'mixed' : ''}">${questionText}</div>
                    <input type="number" class="answer-input" id="answer-${index}"
                           onkeypress="handleKeyPress(event, ${index})" onfocus="recordStartTime(${index})" onblur="checkAnswerOnBlur(${index})">
                `;

                grid.appendChild(card);
            });

            // Ëá™Âä®ËÅöÁÑ¶Á¨¨‰∏Ä‰∏™ËæìÂÖ•Ê°Ü
            setTimeout(() => {
                const firstInput = document.getElementById('answer-0');
                if (firstInput) firstInput.focus();
            }, 100);
        }

        // ËÆ∞ÂΩïÂºÄÂßãÁ≠îÈ¢òÊó∂Èó¥
        function recordStartTime(index) {
            if (!questions[index].startTime) {
                questions[index].startTime = Date.now();
            }
        }

        // ÂàõÂª∫Â•ñÁâåÁ≤íÂ≠êÁâπÊïà
        function createRankParticles(element, rank) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const particleCount = rank === 'diamond' ? 30 : rank === 'gold' ? 20 : rank === 'silver' ? 15 : 10;
            const particles = ['‚≠ê', '‚ú®', 'üåü', 'üí´'];

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.textContent = particles[Math.floor(Math.random() * particles.length)];
                particle.style.cssText = `
                    position: fixed;
                    font-size: ${Math.random() * 20 + 15}px;
                    pointer-events: none;
                    z-index: 9999;
                    left: ${centerX}px;
                    top: ${centerY}px;
                    margin: 0;
                    opacity: 1;
                `;

                const angle = (Math.PI * 2 * i) / particleCount;
                const velocity = Math.random() * 100 + 80;
                const endX = centerX + Math.cos(angle) * velocity;
                const endY = centerY + Math.sin(angle) * velocity;

                document.body.appendChild(particle);

                particle.animate([
                    {
                        transform: 'translate(-50%, -50%) scale(0)',
                        opacity: 1
                    },
                    {
                        transform: 'translate(-50%, -50%) scale(1.2)',
                        opacity: 1,
                        offset: 0.3
                    },
                    {
                        transform: `translate(calc(-50% + ${endX - centerX}px), calc(-50% + ${endY - centerY}px)) scale(0.5)`,
                        opacity: 0
                    }
                ], {
                    duration: 1000 + Math.random() * 500,
                    easing: 'cubic-bezier(0, 0.5, 0.5, 1)'
                }).onfinish = () => particle.remove();
            }
        }

        // ÂàõÂª∫Â∫ÜÁ•ùÂä®Áîª
        function createCelebration(card) {
            const celebration = document.createElement('div');
            celebration.textContent = ['‚≠ê', 'üåü', '‚ú®', 'üå∏', 'üéâ'][Math.floor(Math.random() * 5)];
            celebration.style.cssText = `
                position: absolute;
                font-size: 2em;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                animation: celebrateUp 0.8s ease forwards;
                z-index: 10;
                pointer-events: none;
            `;
            card.appendChild(celebration);

            setTimeout(() => celebration.remove(), 800);
        }

        // ÊòæÁ§∫Âä®Áâ©ÈºìÂä±ËØ≠
        function showAnimalCheer(card) {
            const cheer = animalCheers[Math.floor(Math.random() * animalCheers.length)];
            const cheerEl = document.createElement('div');
            cheerEl.className = 'animal-cheer';
            cheerEl.textContent = `${cheer.animal} ${cheer.text}`;
            card.appendChild(cheerEl);

            setTimeout(() => cheerEl.remove(), 800);
        }

        // Ê∑ªÂä†Â∫ÜÁ•ùÂä®ÁîªÊ†∑Âºè
        const style = document.createElement('style');
        style.textContent = `
            @keyframes celebrateUp {
                0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
                50% { opacity: 1; transform: translate(-50%, -100%) scale(1.5); }
                100% { opacity: 0; transform: translate(-50%, -150%) scale(1); }
            }
        `;
        document.head.appendChild(style);

        // Ëá™Âä®ËÅöÁÑ¶‰∏ã‰∏Ä‰∏™Êú™ÂÆåÊàêÁöÑÈ¢òÁõÆ
        function autoFocusNextQuestion(currentIndex) {
            for (let i = currentIndex + 1; i < questions.length; i++) {
                if (!questions[i].isAnswered) {
                    const nextInput = document.getElementById(`answer-${i}`);
                    if (nextInput) {
                        setTimeout(() => nextInput.focus(), 300);
                    }
                    return;
                }
            }
        }

        // Â§ÑÁêÜÂõûËΩ¶ÈîÆ
        function handleKeyPress(event, index) {
            if (event.key === 'Enter') {
                // Ê£ÄÊü•ÂΩìÂâçÁ≠îÊ°àÂπ∂Ë∑≥Âà∞‰∏ã‰∏ÄÈ¢ò
                if (!questions[index].isAnswered) {
                    checkAnswerAndMove(index);
                } else {
                    // Â¶ÇÊûúÂ∑≤ÂõûÁ≠îËøáÔºåÁõ¥Êé•Ë∑≥Âà∞‰∏ã‰∏ÄÈ¢ò
                    autoFocusNextQuestion(index);
                }
            }
        }

        // Â§ÑÁêÜÂ§±ÁÑ¶‰∫ã‰ª∂ÔºàÂΩìÁî®Êà∑ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÊàñÊåâTabÈîÆÊó∂Ôºâ
        function checkAnswerOnBlur(index) {
            const input = document.getElementById(`answer-${index}`);
            const value = input.value.trim();
            const q = questions[index];

            // Âè™ÊúâÂΩìËæìÂÖ•Ê°ÜÊúâÂÄº‰∏îËøòÊú™Ê£ÄÊü•ËøáÊó∂ÊâçÊ£ÄÊü•
            // Ê≥®ÊÑèÔºöÂ§±ÁÑ¶Êó∂‰∏çËá™Âä®Ë∑≥ËΩ¨ÔºåÈÅøÂÖçÁÑ¶ÁÇπÊ∑∑‰π±
            if (value !== '' && !q.isAnswered) {
                checkAnswerOnly(index);
            }
        }

        // Ê£ÄÊü•Á≠îÊ°àÂπ∂Ëá™Âä®Ë∑≥Âà∞‰∏ã‰∏ÄÈ¢òÔºàÊåâÂõûËΩ¶Êó∂‰ΩøÁî®Ôºâ
        function checkAnswerAndMove(index) {
            checkAnswerOnly(index);
            autoFocusNextQuestion(index);
        }

        // Âè™Ê£ÄÊü•Á≠îÊ°àÔºå‰∏çË∑≥ËΩ¨ÔºàÂ§±ÁÑ¶Êó∂‰ΩøÁî®Ôºâ
        function checkAnswerOnly(index) {
            const input = document.getElementById(`answer-${index}`);
            const value = input.value.trim();
            const card = document.getElementById(`question-${index}`);
            const feedbackIcon = document.getElementById(`feedback-${index}`);
            const q = questions[index];

            // ËÆ∞ÂΩïÁ≠îÈ¢òÊó∂Èó¥
            if (q.startTime && !q.isAnswered) {
                const timeSpent = Math.round((Date.now() - q.startTime) / 1000);
                questionTimes.push(timeSpent);
                q.startTime = null;
            }

            if (value !== '' && !q.isAnswered) {
                const userAnswer = parseInt(value);

                q.isAnswered = true;
                q.userAnswer = userAnswer;

                if (userAnswer === q.answer) {
                    // Á≠îÂØπ‰∫Ü
                    q.isCorrect = true;
                    card.classList.add('correct');
                    feedbackIcon.textContent = '‚úÖ';
                    playSound('correct');
                    createCelebration(card);
                    showAnimalCheer(card);
                    correctCount++;
                } else {
                    // Á≠îÈîô‰∫Ü - Á´ãÂç≥ÊòæÁ§∫ÂèâÂèâÂíåÈü≥Êïà
                    q.isCorrect = false;
                    card.classList.add('wrong');
                    feedbackIcon.textContent = '‚ùå';
                    playSound('wrong');
                    wrongQuestions.push({ ...q, index: index + 1 });
                }

                answeredCount++;
                updateProgress();
            }
        }

        // Êõ¥Êñ∞ËøõÂ∫¶
        function updateProgress() {
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');

            progressText.textContent = `${answeredCount}/20 È¢ò`;
            const percentage = (answeredCount / 20) * 100;
            progressFill.style.width = percentage + '%';
        }

        // Êèê‰∫§Á≠îÊ°à
        function submitAnswers() {
            if (isSubmitted) return;

            // Êî∂ÈõÜÊú™‰ΩúÁ≠îÁöÑÈ¢òÁõÆ
            questions.forEach((q, index) => {
                if (!q.isAnswered) {
                    const input = document.getElementById(`answer-${index}`);
                    const value = input.value.trim();
                    q.userAnswer = value === '' ? null : parseInt(value);
                    q.isAnswered = true;

                    const card = document.getElementById(`question-${index}`);
                    const feedbackIcon = document.getElementById(`feedback-${index}`);

                    if (q.userAnswer === q.answer) {
                        q.isCorrect = true;
                        card.classList.add('correct');
                        feedbackIcon.textContent = '‚úÖ';
                    } else {
                        card.classList.add('wrong');
                        feedbackIcon.textContent = '‚ùå';
                        wrongQuestions.push({ ...q, index: index + 1 });
                    }

                    input.classList.add('disabled');
                    input.disabled = true;
                }
            });

            // ÈáçÊñ∞ÁªüËÆ°ÊâÄÊúâÈ¢òÁõÆÁöÑÊ≠£Á°ÆÊï∞Ôºà‰∏ç‰æùËµñÂÆûÊó∂Ê£ÄÊü•ÁöÑËÆ°Êï∞Ôºâ
            correctCount = questions.filter(q => q.isCorrect).length;
            answeredCount = questions.filter(q => q.isAnswered && q.userAnswer !== null).length;

            updateProgress();
            stopTimer();
            stopCountdown();
            isSubmitted = true;
            document.getElementById('submitBtn').disabled = true;

            // ËÆ°ÁÆóÂæóÂàÜÂπ∂ÊòæÁ§∫ÁªìÊûúÔºàÈü≥ÊïàÂú®showResults‰∏≠Êí≠ÊîæÔºâ
            const score = correctCount * 5;
            showResults(score, correctCount);
            saveHistory(score, correctCount);
            savePersonalRecord(score, correctCount, formatTime(seconds));

            if (wrongQuestions.length > 0) {
                document.getElementById('retryWrongBtn').style.display = 'inline-block';
            }
        }

        // ÊòæÁ§∫ÁªìÊûú
        function showResults(score, correct) {
            console.log('showResults Ë¢´Ë∞ÉÁî® - score:', score, 'correct:', correct);

            try {
                const resultSection = document.getElementById('resultSection');
                resultSection.style.display = 'block';

                document.getElementById('score').textContent = score;
                document.getElementById('correctCount').textContent = correct;
                document.getElementById('wrongCount').textContent = 20 - correct;
                document.getElementById('timeSpent').textContent = formatTime(seconds);

                // ËÆ°ÁÆóÂπ≥ÂùáÁ≠îÈ¢òÊó∂Èó¥
                const avgTime = questionTimes.length > 0 ?
                    Math.round(questionTimes.reduce((a, b) => a + b, 0) / questionTimes.length) : 0;
                document.getElementById('avgTime').textContent = avgTime + 's';

                console.log('Âü∫Êú¨‰ø°ÊÅØÊòæÁ§∫ÂÆåÊàê');

                // ÊÆµ‰ΩçÁ≥ªÁªü - Ê†πÊçÆÂàÜÊï∞Á°ÆÂÆöÊÆµ‰Ωç
                let rankText, rankClass, rank, stars, encouragement;

                console.log('ÂºÄÂßãÂà§Êñ≠ÊÆµ‰Ωç - score:', score, 'scoreÁ±ªÂûã:', typeof score);

                if (score === 100) {
                    rank = 'diamond';
                    rankText = 'üíé ÈíªÁü≥';
                    rankClass = 'rank-diamond';
                    stars = '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê';
                    encouragement = 'üéä Â§™ÂéâÂÆ≥‰∫ÜÔºÅÊª°ÂàÜÈíªÁü≥ÔºÅ‰Ω†ÊòØÊï∞Â≠¶Â∞èÂ§©ÊâçÔºÅü¶ä‚ú®';
                    // Êª°ÂàÜÊîæÁÉüËä±ÂíåÈ≤úËä±
                    setTimeout(() => startFireworks(), 500);
                    playSound('diamond');
                } else if (score >= 90) {
                    rank = 'gold';
                    rankText = 'ü•á ÈáëÁâå';
                    rankClass = 'rank-gold';
                    stars = '‚≠ê‚≠ê‚≠ê‚≠ê';
                    encouragement = 'üéâ Â§™Ê£í‰∫ÜÔºÅÈáëÁâåÔºÅÂè™Â∑Æ‰∏ÄÁÇπÁÇπÂ∞±Êª°ÂàÜ‰∫ÜÔºÅüê∞üí™';
                    playSound('complete');
                } else if (score >= 80) {
                    rank = 'silver';
                    rankText = 'ü•à Èì∂Áâå';
                    rankClass = 'rank-silver';
                    stars = '‚≠ê‚≠ê‚≠ê';
                    encouragement = 'üòä ÂæàÊ£íÔºÅÈì∂ÁâåÔºÅÁªßÁª≠Âä†Ê≤πÂêëÈáëÁâåÂÜ≤Âà∫ÔºÅü¶Å';
                    playSound('complete');
                } else {
                    rank = 'bronze';
                    rankText = 'ü•â ÈìúÁâå';
                    rankClass = 'rank-bronze';
                    stars = score >= 60 ? '‚≠ê‚≠ê' : '‚≠ê';
                    encouragement = 'üí™ ÁªßÁª≠Âä™ÂäõÔºÅÂ§öÁªÉ‰π†Â∞±ËÉΩÂçáÁ∫ßÂà∞Èì∂ÁâåÔºÅüê®';
                    playSound('complete');
                }

                // ÊòæÁ§∫Â•ñÁâåÔºàÊ∑ªÂä†Âä®ÁîªÊïàÊûúÔºâ
                const rankBadge = document.getElementById('rankBadge');
                rankBadge.style.display = 'inline-block';
                rankBadge.textContent = rankText;
                rankBadge.className = 'rank-badge ' + rankClass;

                // Âº∫Âà∂ÈáçÁªò‰ª•ÈáçÊñ∞Ëß¶ÂèëÂä®Áîª
                rankBadge.style.animation = 'none';
                rankBadge.offsetHeight; // Ëß¶ÂèëÈáçÁªò
                rankBadge.style.animation = rank === 'diamond' ? 'diamondGlow 2s ease-in-out infinite, badgePop 0.6s ease' : 'badgePop 0.6s ease';

                // Ëß¶ÂèëÊòüÊòüÁ≤íÂ≠êÁâπÊïà
                setTimeout(() => createRankParticles(rankBadge, rank), 100);

                document.getElementById('stars').textContent = stars;
                document.getElementById('encouragement').textContent = encouragement;

                console.log('Â•ñÁâåÂíåÈºìÂä±ËØ≠ËÆæÁΩÆÂÆåÊàê - rank:', rank);
                // Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆÔºàÂè™Âä†ËΩΩ‰∏ÄÊ¨°ÔºåÈÅøÂÖçÊï∞ÊçÆË¢´Ë¶ÜÁõñÔºâ
                const data = loadUserData();
                const today = new Date().toDateString();

                // Ê£ÄÊü•ÊòØÂê¶ÊòØÊñ∞ÁöÑ‰∏ÄÂ§©ÔºåÂ¶ÇÊûúÊòØÂàôÈáçÁΩÆ‰ªäÊó•ÂæΩÁ´†
                if (data.badgeDate !== today) {
                    data.badgeDate = today;
                    data.bronzeBadges = 0;
                    data.silverBadges = 0;
                    data.goldBadges = 0;
                    data.diamondBadges = 0;
                }

                // Â¢ûÂä†ÂØπÂ∫îÂ•ñÁâåÊï∞Èáè
                if (rank === 'bronze') data.bronzeBadges = (data.bronzeBadges || 0) + 1;
                if (rank === 'silver') data.silverBadges = (data.silverBadges || 0) + 1;
                if (rank === 'gold') data.goldBadges = (data.goldBadges || 0) + 1;
                if (rank === 'diamond') data.diamondBadges = (data.diamondBadges || 0) + 1;

                // Ë∞ÉËØï‰ø°ÊÅØ
                console.log('Â•ñÁâåÁªüËÆ° - rank:', rank, 'bronze:', data.bronzeBadges, 'silver:', data.silverBadges, 'gold:', data.goldBadges, 'diamond:', data.diamondBadges);

                // ËÆ∞ÂΩïÊú¨Ê¨°ÊàêÁª©ÔºàÁî®‰∫é‰ªªÂä°ÂíåËøûËÉúÊ£ÄÊü•Ôºâ
                data.lastRank = rank;
                data.lastCorrect = correct;

                // Êõ¥Êñ∞ÊúÄ‰Ω≥ÊàêÁª©
                const bestScore = Math.max(score, data.bestScore || 0);
                data.bestScore = bestScore;
                document.getElementById('bestScore').textContent = bestScore;

                console.log('ÂáÜÂ§á‰øùÂ≠òÊï∞ÊçÆ');

                // ‰∏ÄÊ¨°ÊÄß‰øùÂ≠òÊâÄÊúâÊï∞ÊçÆ
                saveUserData(data);

                console.log('Êï∞ÊçÆÂ∑≤‰øùÂ≠òÔºåÂáÜÂ§áÊõ¥Êñ∞ÂæΩÁ´†Â¢ô');

                // Êõ¥Êñ∞ÂæΩÁ´†Â¢ôÊòæÁ§∫
                updateBadgeWall();

                // Êõ¥Êñ∞ËøûÁª≠ÁªÉ‰π†Â§©Êï∞
                updateStreak();

                // Ê£ÄÊü•ÊØèÊó•‰ªªÂä°
                checkDailyTasks();

                // Ê£ÄÊü•ËøûËÉúÂ•ñÂä±
                checkWinningStreak();

                // Ê£ÄÊü•ÊàêÂ∞±
                const achievements = checkAchievements(score, rank);
                const achievementShowcase = document.getElementById('achievementShowcase');
                const achievementList = document.getElementById('achievementList');

                if (achievements.length > 0) {
                    achievementShowcase.classList.add('has-achievement');
                    achievementList.innerHTML = achievements.map(a =>
                        `<div class="achievement-badge">${a}</div>`
                    ).join('');
                } else {
                    achievementShowcase.classList.remove('has-achievement');
                }

                // Áªô‰∫àÁßØÂàÜÂ•ñÂä±
                const pointsEarned = correct * 10; // ÊØèÈ¢ò10ÂàÜ
                addPoints(pointsEarned);

                // Áªô‰∫àÁªèÈ™åÂÄºÂ•ñÂä±
                addXP(correct * 5); // ÊØèÈ¢ò5ÁÇπÁªèÈ™å

                // ÊòæÁ§∫ÂÆùÁÆ±Â•ñÂä±
                showChestReward(rank);

            // ÊòæÁ§∫ÈîôÈ¢òÈõÜ
            if (wrongQuestions.length > 0) {
                const wrongSection = document.getElementById('wrongSection');
                const wrongList = document.getElementById('wrongList');
                wrongSection.style.display = 'block';
                wrongList.innerHTML = '';

                wrongQuestions.forEach(q => {
                    const item = document.createElement('div');
                    item.className = 'wrong-item';

                    const explanation = generateExplanation(q);
                    const questionText = q.isMixed ?
                        `Á¨¨${q.index}È¢òÔºö${q.num1} ${q.op1} ${q.num2} ${q.op2} ${q.num3} =` :
                        `Á¨¨${q.index}È¢òÔºö${q.num1} ${q.operator} ${q.num2} =`;

                    item.innerHTML = `
                        <div class="wrong-question ${q.isMixed ? 'mixed' : ''}">${questionText}</div>
                        <div class="wrong-answer">‚ùå ‰Ω†ÁöÑÁ≠îÊ°àÔºö${q.userAnswer === null || q.userAnswer === undefined ? 'Êú™‰ΩúÁ≠î' : q.userAnswer}</div>
                        <div class="correct-answer">‚úÖ Ê≠£Á°ÆÁ≠îÊ°àÔºö${q.answer}</div>
                        <div class="explanation">üí° ${explanation}</div>
                    `;

                    wrongList.appendChild(item);
                });
            } else {
                document.getElementById('wrongSection').style.display = 'none';
            }

            // ÊªöÂä®Âà∞ÁªìÊûúÂå∫Âüü
            setTimeout(() => {
                resultSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
            } catch (error) {
                console.error('showResults ÊâßË°åÂá∫Èîô:', error);
            }
        }

        // ÁîüÊàêËß£Êûê
        function generateExplanation(q) {
            if (q.isMixed) {
                let step1 = q.op1 === '+' ? `${q.num1} + ${q.num2} = ${q.num1 + q.num2}` : `${q.num1} - ${q.num2} = ${q.num1 - q.num2}`;
                const tempResult = q.op1 === '+' ? q.num1 + q.num2 : q.num1 - q.num2;
                let step2 = q.op2 === '+' ? `${tempResult} + ${q.num3} = ${q.answer}` : `${tempResult} - ${q.num3} = ${q.answer}`;
                return `Ê∑∑ÂêàËøêÁÆóËß£ÊûêÔºà‰ªéÂ∑¶Âà∞Âè≥ÔºâÔºö<br>Á¨¨‰∏ÄÊ≠•Ôºö${step1}<br>Á¨¨‰∫åÊ≠•Ôºö${step2}`;
            } else {
                if (q.operator === '+') {
                    return `Âä†Ê≥ïËß£ÊûêÔºö${q.num1} + ${q.num2} = ${q.answer}<br>ÊÄùË∑ØÔºö‰ªé${q.num1}ÂºÄÂßãÔºåÂæÄÂêéÊï∞${q.num2}‰∏™Êï∞Â≠ó`;
                } else {
                    return `ÂáèÊ≥ïËß£ÊûêÔºö${q.num1} - ${q.num2} = ${q.answer}<br>ÊÄùË∑ØÔºö‰ªé${q.num1}ÂºÄÂßãÔºåÂæÄÂâçÊï∞${q.num2}‰∏™Êï∞Â≠ó`;
                }
            }
        }

        // ÈáçÁªÉÈîôÈ¢ò
        function retryWrong() {
            if (wrongQuestions.length === 0) return;

            questions = wrongQuestions.map((q, i) => ({
                num1: q.num1, num2: q.num2, num3: q.num3,
                operator: q.operator, op1: q.op1, op2: q.op2,
                answer: q.answer, isMixed: q.isMixed,
                userAnswer: '', isAnswered: false, isCorrect: false
            }));

            wrongQuestions = [];
            document.getElementById('retryWrongBtn').style.display = 'none';

            isChallengeMode = false;
            document.getElementById('challengeMode').classList.remove('active');
            document.getElementById('challengeBtn').style.display = 'inline-block';
            stopCountdown();

            renderQuestions();
            resetTimer();
            startTimer();
            isSubmitted = false;
            answeredCount = 0;
            currentQuestionIndex = 0;
            updateProgress();
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('resultSection').style.display = 'none';

            playSound('click');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ËÆ°Êó∂Âô®ÂäüËÉΩ
        function startTimer() {
            timerInterval = setInterval(() => {
                seconds++;
                document.getElementById('timer').textContent = formatTime(seconds);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function resetTimer() {
            stopTimer();
            seconds = 0;
            document.getElementById('timer').textContent = '00:00';
        }

        function formatTime(totalSeconds) {
            const mins = Math.floor(totalSeconds / 60);
            const secs = totalSeconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï
        function saveHistory(score, correct) {
            const history = loadHistoryData();
            const questionType = document.getElementById('questionType').value;
            const difficulty = document.getElementById('difficulty').value;

            let rank;
            if (score === 100) rank = 'diamond';
            else if (score >= 90) rank = 'gold';
            else if (score >= 80) rank = 'silver';
            else rank = 'bronze';

            const record = {
                date: new Date().toLocaleString('zh-CN'),
                score: score,
                correct: correct,
                time: formatTime(seconds),
                difficulty: difficulty,
                type: questionType,
                isChallenge: isChallengeMode,
                rank: rank
            };

            history.unshift(record);
            if (history.length > 30) history.pop();

            saveHistoryData(history);
            loadHistory();
        }

        // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
        function loadHistory() {
            const history = loadHistoryData();
            const historySection = document.getElementById('historySection');
            const historyList = document.getElementById('historyList');

            if (history.length > 0) {
                historySection.style.display = 'block';
                historyList.innerHTML = '';

                history.forEach((record, index) => {
                    const item = document.createElement('div');
                    item.className = 'history-item';

                    const difficultyMap = { 'easy': 'üå±', 'medium': 'üåø', 'hard': 'üå≥' };
                    const typeMap = { 'simple': '‚ûï ÁÆÄÂçï', 'mixed': 'üî¢ Ê∑∑Âêà' };
                    const rankMap = { 'silver': 'ü•à ÁôΩÈì∂', 'gold': 'ü•á ÈªÑÈáë', 'diamond': 'üíé ÈíªÁü≥' };

                    let badges = '';
                    if (record.isChallenge) badges += '<span class="history-badge challenge">‚ö°</span>';
                    badges += `<span class="history-badge ${record.rank}">${rankMap[record.rank]}</span>`;

                    item.innerHTML = `
                        <div>
                            <div class="history-date">${record.date}</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">
                                ${difficultyMap[record.difficulty]} ${typeMap[record.type]} | Áî®Êó∂Ôºö${record.time}
                            </div>
                            <div class="history-badges">${badges}</div>
                        </div>
                        <div class="history-score">${record.score}ÂàÜ</div>
                    `;

                    historyList.appendChild(item);
                });
            } else {
                historySection.style.display = 'none';
            }
        }

        // ÈöæÂ∫¶ÊàñÈ¢òÂûãÊîπÂèòÊó∂Ëá™Âä®ÁîüÊàêÊñ∞È¢òÁõÆ
        document.getElementById('difficulty').addEventListener('change', function() {
            if (!isSubmitted || confirm('ÊîπÂèòËÆæÁΩÆÂ∞ÜÁîüÊàêÊñ∞È¢òÁõÆÔºåÁ°ÆÂÆöÂêóÔºü')) {
                newQuestions();
            }
        });

        document.getElementById('questionType').addEventListener('change', function() {
            if (!isSubmitted || confirm('ÊîπÂèòÈ¢òÂûãÂ∞ÜÁîüÊàêÊñ∞È¢òÁõÆÔºåÁ°ÆÂÆöÂêóÔºü')) {
                newQuestions();
            }
        });
    </script>

    <!-- ÂºÄÁÆ±Âä®ÁîªË¶ÜÁõñÂ±Ç -->
    <div class="overlay" id="overlay">
        <div class="chest-open-animation">
            <div class="reward-reveal" id="rewardReveal"></div>
            <div class="reward-name" id="rewardName"></div>
            <div class="rarity-stars" id="rarityStars"></div>
            <button class="collect-btn" onclick="collectReward()">Êî∂‰∏ãÂ•ñÂä±</button>
        </div>
    </div>
</body>
</html>
